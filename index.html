<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>CavaËÆ∞‰∫ãÊú¨1.0beta</title>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
    <style>
        :root {
            --bg-main: #FDF0E9;
            --bg-secondary: #FFFFFF;
            --bg-soft: #FAE1D5;
            --accent-primary: #E6C8B4;
            --accent-secondary: #FFB6A3;
            --text-primary: #8C7B73;
            --text-secondary: #B4A29B;
            --text-primary-rgb: 140, 123, 115;
            --text-secondary-rgb: 180, 162, 155;
            --text-light: #FFFFFF;
            --error-bg: #FADADD;
            --error-text: #8C2323;
            --border-color: #F5EBE4;
            --expense-color: #F28B82;
            --income-color: #8DD4BF;
            --shadow-light: rgba(140, 123, 115, 0.1);
            --shadow-medium: rgba(140, 123, 115, 0.15);
            /* Schedule colors */
            --schedule-urgent-important: #FFE5E5;
            --schedule-urgent-not-important: #FFF5E5;
            --schedule-not-urgent-important: #E5F0FF;
            --schedule-not-urgent-not-important: #F0F0F0;
        }

        body[data-theme="blue"] {
            --bg-main: #EAF6FF;
            --bg-secondary: #FFFFFF;
            --bg-soft: #D4E9F7;
            --accent-primary: #B0D4EC;
            --accent-secondary: #87C4F4;
            --text-primary: #5A7C94;
            --text-secondary: #9AB7CC;
            --text-primary-rgb: 90, 124, 148;
            --text-secondary-rgb: 154, 183, 204;
            --border-color: #E0F0FF;
            --shadow-light: rgba(90, 124, 148, 0.1);
            --shadow-medium: rgba(90, 124, 148, 0.15);
        }

        body[data-theme="green"] {
            --bg-main: #EFF8F2;
            --bg-secondary: #FFFFFF;
            --bg-soft: #DCEEE2;
            --accent-primary: #B9DCD0;
            --accent-secondary: #96CDBC;
            --text-primary: #5E8071;
            --text-secondary: #9EBAAF;
            --text-primary-rgb: 94, 128, 113;
            --text-secondary-rgb: 158, 186, 175;
            --border-color: #E5F1E9;
            --shadow-light: rgba(94, 128, 113, 0.1);
            --shadow-medium: rgba(94, 128, 113, 0.15);
        }

        body[data-theme="purple"] {
            --bg-main: #F6F2FF;
            --bg-secondary: #FFFFFF;
            --bg-soft: #EAE0F7;
            --accent-primary: #D4C2E8;
            --accent-secondary: #C0A9E0;
            --text-primary: #7C6B8F;
            --text-secondary: #A99CB8;
            --text-primary-rgb: 124, 107, 143;
            --text-secondary-rgb: 169, 156, 184;
            --border-color: #F0EBFA;
            --shadow-light: rgba(124, 107, 143, 0.1);
            --shadow-medium: rgba(124, 107, 143, 0.15);
        }

        body[data-theme="pink"] {
            --bg-main: #FFF0F5;
            --bg-secondary: #FFFFFF;
            --bg-soft: #FFE2EC;
            --accent-primary: #F8C4D8;
            --accent-secondary: #F4AAB6;
            --text-primary: #9A6A74;
            --text-secondary: #C7A5AD;
            --text-primary-rgb: 154, 106, 116;
            --text-secondary-rgb: 199, 165, 173;
            --border-color: #FAEBF0;
            --shadow-light: rgba(154, 106, 116, 0.1);
            --shadow-medium: rgba(154, 106, 116, 0.15);
        }

        body[data-theme="gray"] {
            --bg-main: #F5F5F5;
            --bg-secondary: #FFFFFF;
            --bg-soft: #EAEAEA;
            --accent-primary: #D1D1D1;
            --accent-secondary: #B0B0B0;
            --text-primary: #616161;
            --text-secondary: #9E9E9E;
            --text-primary-rgb: 97, 97, 97;
            --text-secondary-rgb: 158, 158, 158;
            --border-color: #EEEEEE;
            --shadow-light: rgba(97, 97, 97, 0.1);
            --shadow-medium: rgba(97, 97, 97, 0.15);
        }

        html, body {
            height: 100%;
            overflow: hidden;
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", sans-serif;
            background-color: var(--bg-main);
            color: var(--text-primary);
            -webkit-tap-highlight-color: transparent;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        #app-container {
            width: 100%;
            height: 100%;
            max-width: 430px;
            margin: 0 auto;
            background-color: var(--bg-main);
            display: flex;
            flex-direction: column;
            position: relative;
            box-shadow: 0 0 30px var(--shadow-medium);
            transition: background-color 0.3s ease;
            overflow: hidden;
        }

        .main-content {
            flex-grow: 1;
            position: relative;
            overflow: hidden;
        }

        .page {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            background-color: var(--bg-main);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease, background-color 0.3s ease;
        }

        .page.active {
            opacity: 1;
            visibility: visible;
            z-index: 1;
        }
        
        /* Header */
        .header {
            flex-shrink: 0;
            padding: 12px 16px;
            padding-top: calc(12px + env(safe-area-inset-top));
            background-color: rgba(253, 240, 233, 0.8);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 18px;
            font-weight: 600;
            z-index: 10;
            transition: background-color 0.3s ease, border-bottom-color 0.3s ease;
        }
        body[data-theme="blue"] .header { background-color: rgba(234, 246, 255, 0.8); }
        body[data-theme="green"] .header { background-color: rgba(239, 248, 242, 0.8); }
        body[data-theme="purple"] .header { background-color: rgba(246, 242, 255, 0.8); }
        body[data-theme="pink"] .header { background-color: rgba(255, 240, 245, 0.8); }
        body[data-theme="gray"] .header { background-color: rgba(245, 245, 245, 0.8); }

        .header .action-btn { font-size: 24px; cursor: pointer; width: 30px; height: 30px; text-align: center; color: var(--accent-primary); display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: background-color 0.2s; }
        .header .action-btn:active { background-color: var(--border-color); }
        .header .back-btn { font-size: 22px; font-weight: bold; }
        .header .left-action { flex: 1 1 0; display: flex; justify-content: flex-start; }
        .header .right-action { flex: 1 1 0; display: flex; justify-content: flex-end; }
        .header .center-title { flex: 2 1 0; text-align: center; }

        /* Bottom Navigation */
        #bottom-nav {
            flex-shrink: 0;
            display: flex;
            background-color: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border-top: 1px solid var(--border-color);
            padding-bottom: env(safe-area-inset-bottom);
            z-index: 100;
            transition: background-color 0.3s ease, border-top-color 0.3s ease;
        }
        body[data-theme="blue"] #bottom-nav,
        body[data-theme="green"] #bottom-nav,
        body[data-theme="purple"] #bottom-nav,
        body[data-theme="pink"] #bottom-nav,
        body[data-theme="gray"] #bottom-nav {
            background-color: rgba(255, 255, 255, 0.7);
        }

        .nav-item { flex: 1; padding: 8px 0; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; color: var(--text-secondary); transition: color 0.2s ease; }
        .nav-item .icon { font-size: 24px; margin-bottom: 2px; }
        .nav-item .label { font-size: 11px; font-weight: 500; }
        .nav-item.active { color: var(--accent-secondary); }

        /* --- Chat Page Styles --- */
        #accounting-screen { background-size: cover; background-position: center; }
        #chat-messages { flex-grow: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 12px; }

        .message-wrapper {
            display: flex;
            gap: 8px;
            max-width: 85%;
            position: relative;
            align-items: flex-start; /* Aligns top of avatar with top of message-block */
        }
        .message-wrapper.user { align-self: flex-end; }
        .message-wrapper.ai { align-self: flex-start; }
        
        .message-wrapper .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
        }
        .message-block {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            flex-grow: 1;
            min-width: 0; /* Prevents flexbox overflow issues */
        }
        .message-wrapper.user .message-block { align-items: flex-end; }
        
        .sender-name {
            font-size: 12px;
            color: #FFFFFF;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
            margin-bottom: 4px;
        }
        .message-bubble {
            display: flex;
            width: fit-content;
            max-width: 100%;
            align-items: flex-end; /* Aligns bubble content with meta info */
            gap: 4px;
        }
        .message-bubble .content {
            padding: 10px 14px;
            word-break: break-word;
            line-height: 1.5;
            font-size: 16px;
            box-shadow: 0 2px 5px var(--shadow-light);
            transition: background-color 0.3s, color 0.3s;
        }
        .message-bubble .content strong { font-weight: bold; }
        .message-bubble .content em { font-style: italic; }
        .message-wrapper.user .message-bubble .content { background-color: var(--bg-soft); color: var(--text-primary); border-radius: 18px 8px 18px 18px; }
        .message-wrapper.ai .message-bubble .content { background-color: var(--bg-secondary); color: var(--text-primary); border-radius: 8px 18px 18px 18px; }
        .message-wrapper.error .message-bubble .content { background-color: var(--error-bg); color: var(--error-text); }
        
        .message-meta {
            display: flex;
            gap: 4px;
            align-items: center;
            opacity: 0;
            transition: opacity 0.2s;
            flex-shrink: 0;
            margin-bottom: 4px; /* Minor adjustment for better visual alignment */
        }
        .message-wrapper:hover .message-meta { opacity: 1; }
        
        .timestamp { font-size: 10px; color: var(--text-secondary); }
        .message-actions-trigger {
            font-family: 'Segoe UI Symbol', sans-serif;
            font-size: 20px;
            color: #FFFFFF;
            background-color: rgba(var(--text-secondary-rgb), 0.5);
            cursor: pointer;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .message-wrapper.user .message-bubble { flex-direction: row-reverse; }
        .selection-mode-active .message-meta, .message-bubble.editing .message-meta { display: none; }

        .message-bubble.image .content { padding: 5px; border-radius: 18px; }
        .chat-image { max-width: 200px; max-height: 200px; border-radius: 13px; display: block; cursor: pointer; }

        @keyframes typing { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
        .typing-indicator span { animation: typing 1.5s infinite; display: inline-block; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

        #chat-input-area {
            flex-shrink: 0;
            padding: 8px 12px;
            padding-bottom: calc(8px + env(safe-area-inset-bottom));
            background-color: rgba(253, 240, 233, 0.8);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-top: 1px solid var(--border-color);
            display: flex;
            align-items: flex-end;
            gap: 8px;
            transition: background-color 0.3s ease, border-top-color 0.3s ease, transform 0.3s ease;
        }
        .selection-mode-active #chat-input-area { transform: translateY(100%); }

        .chat-action-btn { width: 36px; height: 36px; border-radius: 50%; border: none; background-color: var(--bg-secondary); color: var(--text-primary); font-size: 20px; cursor: pointer; display: flex; justify-content: center; align-items: center; flex-shrink: 0; box-shadow: 0 1px 3px var(--shadow-light); transition: transform 0.2s, background-color 0.3s; }
        .chat-action-btn:active { transform: scale(0.9); background-color: var(--bg-soft); }
        #chat-input { flex-grow: 1; border: none; padding: 10px 15px; border-radius: 18px; background-color: var(--bg-secondary); font-size: 16px; max-height: 100px; resize: none; box-shadow: 0 1px 3px var(--shadow-light); transition: background-color 0.3s; }
        #chat-input:focus { outline: none; }
        #send-btn { background-color: var(--accent-secondary); color: var(--text-light); font-weight: 600; font-size: 14px; flex-shrink: 0; height: 36px; padding: 0 15px; border-radius: 18px; border: none; cursor: pointer; transition: background-color 0.3s; }
        #send-btn:disabled { background-color: var(--accent-primary); cursor: not-allowed; }
        
        /* Plus Menu */
        #plus-menu {
            position: absolute;
            bottom: 60px;
            left: 12px;
            background-color: var(--bg-secondary);
            border-radius: 12px;
            box-shadow: 0 4px 12px var(--shadow-medium);
            padding: 8px;
            display: none;
            z-index: 150;
            min-width: 140px;
        }
        #plus-menu.visible { display: block; }
        #plus-menu button {
            display: block;
            width: 100%;
            padding: 12px 16px;
            border: none;
            background: none;
            color: var(--text-primary);
            font-size: 16px;
            text-align: left;
            cursor: pointer;
            border-radius: 8px;
            transition: background-color 0.2s;
        }
        #plus-menu button:hover { background-color: var(--bg-soft); }

        /* Selection Mode */
        #selection-action-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            flex-shrink: 0;
            padding: 8px 12px;
            padding-bottom: calc(8px + env(safe-area-inset-bottom));
            background-color: rgba(253, 240, 233, 0.9);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-top: 1px solid var(--border-color);
            display: none;
            justify-content: space-between;
            align-items: center;
            z-index: 15;
            box-sizing: border-box;
        }
        .selection-mode-active #selection-action-bar { display: flex; }
        #selection-action-bar button {
            padding: 10px 20px;
            font-size: 16px;
            border-radius: 18px;
            border: none;
            cursor: pointer;
        }
        #delete-selected-btn { background-color: var(--error-bg); color: var(--error-text); }
        #cancel-selection-btn { background-color: var(--border-color); color: var(--text-primary); }
        .message-selection-checkbox {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            border: 2px solid var(--accent-primary);
            background-color: var(--bg-secondary);
            border-radius: 50%;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            color: var(--text-light);
            font-size: 14px;
            z-index: 5;
        }
        .selection-mode-active .message-selection-checkbox { display: flex; }
        .message-wrapper.user .message-selection-checkbox { left: -30px; }
        .message-wrapper.ai .message-selection-checkbox { right: -30px; }
        .message-wrapper.selected .message-selection-checkbox {
            background-color: var(--accent-secondary);
            border-color: var(--accent-secondary);
        }
        .selection-mode-active #chat-messages { padding-left: 40px; padding-right: 40px; }

        /* Transaction, Schedule & Summary Message Cards */
        .message-bubble.transaction .content, .message-bubble.schedule .content,
        .message-bubble.ledger_summary .content, .message-bubble.schedule_summary .content, .message-bubble.pie_chart_summary .content { padding: 0; background: transparent; box-shadow: none; }
        .transaction-card, .schedule-card, .summary-card { width: 220px; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 12px var(--shadow-medium); background: var(--bg-secondary); }
        .transaction-header, .schedule-header, .summary-header { padding: 10px 15px; display: flex; align-items: center; gap: 10px; color: var(--text-light); }
        .transaction-header.expense { background-color: var(--expense-color); }
        .transaction-header.income { background-color: var(--income-color); }
        .schedule-header { background-color: var(--accent-secondary); }
        .summary-header { background-color: var(--accent-primary); }
        .transaction-header .icon, .schedule-header .icon, .summary-header .icon { font-size: 24px; }
        .transaction-header .category-name, .schedule-header .type-name, .summary-header .type-name { font-size: 16px; font-weight: bold; }
        .transaction-body, .schedule-body, .summary-body { padding: 15px; text-align: center; }
        .transaction-amount { font-size: 28px; font-weight: bold; color: var(--text-primary); margin-bottom: 8px; }
        .transaction-amount .currency-label { font-size: 0.5em; }
        .transaction-remark { font-size: 14px; color: var(--text-secondary); border-top: 1px dashed var(--border-color); padding-top: 8px; word-break: break-all; position: relative; }
        .transaction-remark:before { content: 'üìù '; }
        .schedule-title { font-size: 18px; font-weight: bold; color: var(--text-primary); margin-bottom: 8px; }
        .schedule-importance, .schedule-deadline, .schedule-status { font-size: 14px; color: var(--text-secondary); margin-bottom: 5px; }
        .schedule-status.completed { color: var(--income-color); font-weight: 500; }
        .schedule-description { font-size: 14px; color: var(--text-secondary); border-top: 1px dashed var(--border-color); padding-top: 8px; word-break: break-all; }
        .summary-body .text { font-size: 14px; color: var(--text-secondary); }

        /* Inline Edit Styles */
        .inline-edit-container {
            display: none;
            flex-direction: column;
            width: 100%;
            padding: 10px 14px;
            box-sizing: border-box;
        }
        .message-bubble.editing .content-text,
        .message-bubble.editing .transaction-remark .original-text,
        .message-bubble.editing .schedule-description .original-text {
            display: none;
        }
        .message-bubble.editing .transaction-remark::before,
        .message-bubble.editing .schedule-description::before {
             display: none;
        }
        .message-bubble.editing .inline-edit-container {
            display: flex;
        }
        .message-bubble.editing.text .content {
            padding: 0;
        }
        .message-bubble.editing.transaction .transaction-remark,
        .message-bubble.editing.schedule .schedule-description {
            padding-top: 0;
            border-top: none;
        }
        .transaction-card .inline-edit-container,
        .schedule-card .inline-edit-container {
            padding: 8px 0 0 0;
        }
        .inline-edit-textarea {
            width: 100%;
            border: 1px solid var(--accent-primary);
            border-radius: 8px;
            font-size: 16px;
            padding: 10px 14px;
            box-sizing: border-box;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            resize: none;
            min-height: 40px;
            font-family: inherit;
            line-height: 1.5;
            overflow-y: hidden;
        }
        .transaction-card .inline-edit-textarea,
        .schedule-card .inline-edit-textarea {
             font-size: 14px;
             padding: 8px;
             line-height: 1.4;
        }

        .inline-edit-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 8px;
        }
        .inline-edit-actions button {
            border: none;
            background-color: var(--bg-soft);
            color: var(--text-primary);
            width: 30px;
            height: 30px;
            border-radius: 50%;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }
        .inline-edit-actions button:active {
            transform: scale(0.9);
        }
        .inline-edit-actions .save {
            background-color: var(--income-color);
            color: white;
        }
        .inline-edit-actions .cancel {
            background-color: var(--expense-color);
            color: white;
        }

        /* Transaction Input Panel */
        #transaction-panel { position: absolute; bottom: 0; left: 0; width: 100%; background-color: var(--bg-main); border-top-left-radius: 20px; border-top-right-radius: 20px; box-shadow: 0 -5px 20px var(--shadow-medium); z-index: 200; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), background-color 0.3s ease; visibility: hidden; }
        #transaction-panel.visible { transform: translateY(0); visibility: visible; }
        .panel-header { padding: 8px 15px; text-align: center; font-weight: 600; position: relative; }
        .panel-header .close-btn { position: absolute; left: 15px; top: 8px; font-size: 18px; line-height: 1; color: var(--text-secondary); cursor: pointer; }
        .type-selector { display: flex; padding: 0 15px; margin-bottom: 15px; }
        .type-selector button { flex: 1; padding: 10px; font-size: 16px; border: none; background: transparent; color: var(--text-secondary); cursor: pointer; position: relative; }
        .type-selector button.active { color: var(--text-primary); font-weight: bold; }
        .type-selector button.active::after { content: ''; position: absolute; bottom: -2px; left: 50%; transform: translateX(-50%); width: 30px; height: 3px; background-color: var(--accent-secondary); border-radius: 2px; }
        #category-selector { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; padding: 0 15px 15px; max-height: 200px; overflow-y: auto; }
        .category-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; padding: 5px; border-radius: 8px; transition: background-color 0.2s; }
        .category-item.selected { background-color: var(--bg-soft); }
        .category-item .icon { font-size: 28px; margin-bottom: 5px; }
        .category-item .name { font-size: 12px; }
        
        /* New Transaction Remark Section Styles */
        .transaction-remark-section {
            padding: 10px 15px;
            background-color: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            border-bottom: 1px solid var(--border-color);
        }
        #transaction-remark-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--bg-main);
            color: var(--text-primary);
            font-size: 16px;
            box-sizing: border-box;
        }
        #transaction-remark-input:focus {
            outline: none;
            border-color: var(--accent-primary);
        }
        #transaction-remark-input::placeholder {
            color: var(--text-secondary);
        }

        #numpad-container { display: grid; grid-template-columns: 3fr 1fr; background-color: var(--bg-secondary); padding-bottom: env(safe-area-inset-bottom); }
        .numpad { display: grid; grid-template-columns: repeat(3, 1fr); }
        .numpad button { padding: 20px 0; font-size: 24px; border: none; background: transparent; border-top: 1px solid var(--border-color); border-right: 1px solid var(--border-color); cursor: pointer; color: var(--text-primary); }
        .numpad button:active { background-color: var(--bg-soft); }
        .numpad .zero { grid-column: 1 / 3; }
        .numpad-actions { display: flex; flex-direction: column; }
        .numpad-actions button { flex: 1; font-size: 22px; border: none; background: transparent; border-top: 1px solid var(--border-color); cursor: pointer; color: var(--text-primary); }
        .numpad-actions button:active { background-color: var(--bg-soft); }
        .numpad-actions .confirm { background-color: var(--accent-secondary); color: white; font-weight: bold; font-size: 18px; }
        #amount-display-container { padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; background: var(--bg-secondary); border-top-left-radius: 20px; border-top-right-radius: 20px; }
        #currency-selector { font-size: 18px; font-weight: bold; color: var(--text-secondary); padding: 5px; cursor: pointer; }
        #amount-display { font-size: 32px; font-weight: bold; text-align: right; flex-grow: 1; }

        /* Schedule Input Panel */
        #schedule-panel {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: var(--bg-main);
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            box-shadow: 0 -5px 20px var(--shadow-medium);
            z-index: 200;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), background-color 0.3s ease;
            visibility: hidden;
            display: flex;
            flex-direction: column;
            max-height: 80vh;
        }
        #schedule-panel.visible {
            transform: translateY(0);
            visibility: visible;
        }
        .schedule-form {
            padding: 15px;
            overflow-y: auto;
        }
        .schedule-form-section {
            padding: 10px;
            border-radius: 12px;
            margin-bottom: 15px;
        }
        .schedule-form-section label {
            display: block;
            font-size: 14px;
            color: var(--text-primary);
            font-weight: 500;
            margin-bottom: 8px;
            padding-left: 5px;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        .schedule-form-section.red { background-color: #F8D7DA; }
        .schedule-form-section.pink { background-color: #F8C4D8; }
        .schedule-form-section.purple { background-color: #EAE0F7; }
        .schedule-form-section.blue { background-color: #D4E9F7; }
        
        .event-type-toggle {
            display: flex;
            gap: 10px;
            background: var(--bg-secondary);
            padding: 5px;
            border-radius: 8px;
        }
        .event-type-toggle button {
            flex: 1;
            padding: 8px;
            border: 1px solid transparent;
            background-color: transparent;
            color: var(--text-secondary);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .event-type-toggle button.active {
            background-color: var(--accent-secondary);
            color: white;
            border-color: var(--accent-secondary);
        }
        .importance-stars {
            display: flex;
            gap: 5px;
            align-items: center;
            background: var(--bg-secondary);
            padding: 8px 12px;
            border-radius: 8px;
        }
        .star {
            font-size: 24px;
            cursor: pointer;
            color: var(--border-color);
            transition: color 0.2s;
            user-select: none;
        }
        .star.filled { color: #FFB800; }
        .star.half { position: relative; color: var(--border-color); }
        .star.half::before {
            content: '‚òÖ';
            position: absolute;
            left: 0;
            width: 50%;
            overflow: hidden;
            color: #FFB800;
        }
        .importance-score {
            margin-left: auto;
            font-size: 16px;
            font-weight: bold;
            color: var(--text-primary);
        }
        .deadline-inputs {
            display: flex;
            align-items: center;
            background: var(--bg-secondary);
            padding: 5px 12px;
            border-radius: 8px;
        }
        #deadline-display-text {
            flex-grow: 1;
            text-align: left;
            color: var(--text-secondary);
            font-size: 16px;
            cursor: pointer;
            padding: 8px 5px;
        }
        .time-input-part {
            display: flex;
            align-items: center;
        }
        .time-input {
            width: 35px;
            border: none;
            background: transparent;
            text-align: center;
            font-size: 16px;
            color: var(--text-primary);
            padding: 8px 0;
        }
        .time-input::-webkit-outer-spin-button,
        .time-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .time-input[type=number] {
            -moz-appearance: textfield;
        }
        .time-input:focus {
            outline: none;
        }
        .time-input::placeholder {
            color: var(--text-secondary);
        }
        .time-separator {
            color: var(--text-primary);
            padding: 0 2px;
            font-size: 16px;
        }

        #schedule-title-input, #schedule-description-input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 16px;
            box-sizing: border-box;
        }
        #schedule-description-input { min-height: 60px; resize: vertical; }
        
        .schedule-actions {
            display: flex;
            gap: 10px;
            padding: 15px;
            border-top: 1px solid var(--border-color);
            margin-top: auto;
            padding-bottom: calc(15px + env(safe-area-inset-bottom));
        }
        .schedule-actions button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 18px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }
        .schedule-actions .cancel-btn { background-color: var(--border-color); color: var(--text-primary); }
        .schedule-actions .confirm-btn { background-color: var(--accent-secondary); color: white; }

        /* Calendar Modal */
        #calendar-modal .modal-content { max-width: 320px; }
        #calendar-modal .modal-body { padding: 5px; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; padding: 10px; }
        .calendar-header button { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-primary); }
        .calendar-month-year { font-size: 18px; font-weight: 600; }
        .calendar-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; font-size: 12px; color: var(--text-secondary); padding-bottom: 5px; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; }
        .calendar-day {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .calendar-day.other-month { color: var(--text-secondary); opacity: 0.5; }
        .calendar-day:not(.other-month):hover { background-color: var(--bg-soft); }
        .calendar-day.today { font-weight: bold; border: 1px solid var(--accent-primary); }
        .calendar-day.selected { background-color: var(--accent-secondary); color: white; }
        #calendar-modal .modal-footer { justify-content: space-between; }
        #clear-date-btn { background-color: var(--error-bg); color: var(--error-text); }


        /* Schedule Page */
        #schedule-screen .page-content { flex-grow: 1; overflow-y: auto; padding: 15px; }
        .schedule-section { margin-bottom: 30px; }
        .schedule-section-title { font-size: 18px; font-weight: 600; color: var(--text-primary); margin-bottom: 15px; padding-bottom: 5px; border-bottom: 2px solid var(--accent-primary); }
        .schedule-quadrant { margin-bottom: 20px; }
        .quadrant-header { display: flex; align-items: center; margin-bottom: 10px; padding: 8px 12px; border-radius: 8px; }
        .quadrant-title { font-size: 14px; font-weight: 600; color: var(--text-primary); }
        #quadrant-1 .quadrant-header { background-color: var(--schedule-urgent-important); }
        #quadrant-2 .quadrant-header { background-color: var(--schedule-not-urgent-important); }
        #quadrant-3 .quadrant-header { background-color: var(--schedule-urgent-not-important); }
        #quadrant-4 .quadrant-header { background-color: var(--schedule-not-urgent-not-important); }
        .schedule-items { display: flex; flex-direction: column; gap: 8px; }
        .schedule-item { display: flex; align-items: center; padding: 12px; background-color: var(--bg-secondary); border-radius: 8px; box-shadow: 0 2px 5px var(--shadow-light); cursor: pointer; transition: transform 0.2s; }
        .schedule-item:active { transform: scale(0.98); }
        .schedule-item .title { flex-grow: 1; font-size: 16px; color: var(--text-primary); }
        .schedule-item .checkbox { width: 20px; height: 20px; border: 2px solid var(--accent-primary); border-radius: 4px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; margin-left: 10px; }
        .schedule-item.completed .checkbox { background-color: var(--accent-secondary); border-color: var(--accent-secondary); }
        .schedule-item.completed .checkbox::after { content: '‚úì'; color: white; font-weight: bold; }
        .schedule-item.completed .title { text-decoration: line-through; color: var(--text-secondary); }
        .empty-state { text-align: center; padding: 20px; color: var(--text-secondary); }

        /* Ledger Page */
        #ledger-screen .page-content { flex-grow: 1; overflow: hidden; padding: 0 0 15px 0; display: flex; flex-direction: column; }
        .ledger-controls { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; padding: 15px 15px 15px; border-bottom: 1px solid var(--border-color); }
        .ledger-controls .filter-btn { border: 1px solid var(--accent-primary); background: var(--bg-secondary); color: var(--text-primary); border-radius: 8px; padding: 6px 10px; font-size: 14px; flex-grow: 1; cursor: pointer; }
        .ledger-controls select { border: 1px solid var(--accent-primary); background: var(--bg-secondary); color: var(--text-primary); border-radius: 8px; padding: 6px 10px; font-size: 14px; flex-grow: 1; }
        .ledger-footer-controls { display: flex; justify-content: space-between; align-items: center; padding: 0 15px; margin-top: 15px; }
        
        /* Vertical Align Fix */
        #ledger-currency { 
            border: 1px solid var(--accent-primary); 
            background: var(--bg-secondary); 
            color: var(--text-primary); 
            border-radius: 8px; 
            padding: 6px 10px; 
            font-size: 14px; 
            height: 34px;
            box-sizing: border-box;
            display: flex;
            align-items: center;
        }
        #toggle-ledger-view-btn { 
            border: 1px solid var(--accent-primary); 
            background: var(--bg-secondary); 
            color: var(--text-primary); 
            border-radius: 8px; 
            padding: 6px 10px; 
            font-size: 14px; 
            line-height: 1; 
            cursor: pointer; 
            height: 34px;
            box-sizing: border-box;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #ledger-view-wrapper { display: flex; height: 100%; transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); flex-grow: 1; }
        #ledger-list-view, #ledger-chart-view { width: 100%; height: 100%; overflow-y: auto; flex-shrink: 0; box-sizing: border-box; }
        #ledger-list-view { padding: 15px 15px 0; }
        #ledger-chart-view { padding: 15px 15px 0; display: flex; flex-direction: column; gap: 20px; position: relative; }
        
        .pie-chart-area { width: 100%; }
        .pie-chart-title-wrapper { text-align: center; margin: 0 0 10px 0; }
        .pie-chart-subtitle { font-size: 12px; color: var(--text-secondary); font-weight: normal; margin: 0; }
        .pie-chart-title { font-size: 18px; font-weight: 600; color: var(--text-primary); margin: 0; }
        .pie-chart-area svg { width: 100%; max-width: 300px; margin: 0 auto; display: block; aspect-ratio: 1; }
        .pie-chart-area svg path { stroke: var(--bg-main); stroke-width: 2px; cursor: pointer; transition: transform 0.2s ease-out; transform-origin: center center; }
        .pie-chart-area svg path.active { transform: scale(1.05); }

        #pie-chart-tooltip {
            position: absolute;
            display: none;
            background: rgba(var(--text-primary-rgb, 0, 0, 0), 0.85);
            color: var(--bg-secondary);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 14px;
            line-height: 1.4;
            pointer-events: none;
            z-index: 10;
            transform: translate(-50%, -110%);
            white-space: nowrap;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        #pie-chart-tooltip strong { font-weight: bold; }

        .pie-legend { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px 15px; padding: 10px; margin-top: 5px; }
        .legend-item { display: flex; align-items: center; font-size: 12px; color: var(--text-primary); }
        .legend-color-box { width: 12px; height: 12px; border-radius: 3px; margin-right: 6px; }
        
        #ledger-list { list-style: none; padding: 0; margin: 0; }
        .ledger-item { background-color: var(--bg-secondary); border-radius: 12px; margin-bottom: 12px; padding: 12px 15px; display: flex; align-items: center; box-shadow: 0 2px 5px var(--shadow-light); cursor: pointer; transition: transform 0.2s; }
        .ledger-item:active { transform: scale(0.98); }
        .ledger-item .icon { font-size: 28px; margin-right: 15px; }
        .ledger-item .details { flex-grow: 1; }
        .ledger-item .details .remark { font-weight: 500; margin-bottom: 4px; }
        .ledger-item .details .time { font-size: 12px; color: var(--text-secondary); }
        .ledger-item .amount { font-size: 18px; font-weight: bold; }
        .ledger-item .amount.expense { color: var(--expense-color); }
        .ledger-item .amount.income { color: var(--income-color); }
        #ledger-summary { text-align: center; padding: 20px 0 0 0; color: var(--text-secondary); }

        /* More/Settings Page */
        #more-screen .page-content { flex-grow: 1; overflow-y: auto; padding: 20px; }
        .setting-group { margin-bottom: 25px; }
        .setting-group-title { font-size: 16px; font-weight: 600; margin-bottom: 15px; padding-bottom: 5px; border-bottom: 2px solid var(--accent-primary); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; font-size: 14px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 1px solid var(--accent-primary); border-radius: 8px; font-size: 16px; box-sizing: border-box; background-color: var(--bg-secondary); color: var(--text-primary); }
        .form-group textarea { min-height: 80px; resize: vertical; }
        .form-button { width: 100%; padding: 14px; background-color: var(--accent-secondary); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; margin-top: 10px; }
        .form-button.secondary { background-color: var(--accent-primary); }
        .list-item-setting { background-color: var(--bg-secondary); border-radius: 8px; padding: 12px; margin-bottom: 10px; box-shadow: 0 1px 3px var(--shadow-light); position: relative; }
        .list-item-setting .name { font-weight: 500; }
        .list-item-setting .details { font-size: 12px; color: var(--text-secondary); word-break: break-all; }
        .list-item-actions { position: absolute; top: 50%; transform: translateY(-50%); right: 10px; display: flex; gap: 5px; }
        .list-item-actions button { border: none; background: none; font-size: 18px; cursor: pointer; color: var(--text-secondary); }
        .avatar-upload { display: flex; align-items: center; gap: 15px; }
        .avatar-upload img { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; background-color: var(--border-color); }
        .avatar-upload button { padding: 8px 12px; border: 1px solid var(--accent-primary); background-color: transparent; color: var(--text-primary); border-radius: 5px; cursor: pointer; }
        .avatar-upload input[type="file"] { display: none; }
        
        /* Theme Selector */
        .theme-selector { display: flex; gap: 15px; flex-wrap: wrap; }
        .theme-option { cursor: pointer; text-align: center; }
        .theme-option .swatch { width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--border-color); margin-bottom: 5px; display: flex; justify-content: center; align-items: center; transition: border-color 0.2s; }
        .theme-option .swatch.default { background-color: #FAE1D5; }
        .theme-option .swatch.blue { background-color: #D4E9F7; }
        .theme-option .swatch.green { background-color: #DCEEE2; }
        .theme-option .swatch.purple { background-color: #EAE0F7; }
        .theme-option .swatch.pink { background-color: #FFE2EC; }
        .theme-option .swatch.gray { background-color: #EAEAEA; }
        .theme-option input { display: none; }
        .theme-option input:checked + .swatch { border-color: var(--accent-secondary); }
        .theme-option input:checked + .swatch::after { content: '‚úì'; color: var(--accent-secondary); font-weight: bold; }
        .theme-option .label { font-size: 12px; }
        
        /* Modals */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-overlay.visible { display: flex; }
        .modal-content { width: 90%; max-width: 350px; background-color: var(--bg-main); border-radius: 15px; display: flex; flex-direction: column; box-shadow: 0 5px 20px var(--shadow-medium); }
        .modal-header { padding: 15px; font-weight: 600; border-bottom: 1px solid var(--border-color); text-align: center; }
        .modal-body { padding: 15px; overflow-y: auto; max-height: 70vh; }
        .modal-footer { padding: 15px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 10px; }
        .modal-footer button { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-size: 16px; font-weight: 500; }
        .modal-footer .save-btn { background-color: var(--accent-secondary); color: white; }
        .modal-footer .cancel-btn { background-color: var(--border-color); color: var(--text-primary); }
        #ai-character-selector .character-item { padding: 12px; border-radius: 8px; margin-bottom: 10px; background-color: var(--bg-secondary); display: flex; align-items: center; gap: 12px; cursor: pointer; }
        #ai-character-selector .character-item:hover { background-color: var(--bg-soft); }
        #ai-character-selector .character-item img { width: 40px; height: 40px; border-radius: 50%; }
        #ai-character-selector .character-item .name { font-weight: bold; }
        #message-action-menu { z-index: 1100; }
        #message-action-menu .modal-content { width: 200px; }
        #message-action-menu .modal-body { padding: 0; }
        #message-action-menu button { width: 100%; display: block; padding: 15px; background: none; border: none; border-bottom: 1px solid var(--border-color); font-size: 16px; cursor: pointer; text-align: center; }
        #message-action-menu button:last-child { border-bottom: none; }
        #message-action-menu button.danger { color: var(--error-text); }
        #schedule-detail-modal .modal-body .detail-row { margin-bottom: 15px; }
        #schedule-detail-modal .modal-body .detail-label { font-size: 12px; color: var(--text-secondary); margin-bottom: 5px; }
        #schedule-detail-modal .modal-body .detail-value { font-size: 16px; color: var(--text-primary); white-space: pre-wrap; word-break: break-all; }
        
        /* Cropper Modal */
        #cropper-modal .modal-body { padding: 0; }
        #cropper-image-container { max-height: 60vh; }
        #cropper-image-container img { max-width: 100%; }

        /* Sidebar */
        #sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
            z-index: 198;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        #sidebar-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        #chat-sidebar {
            position: absolute;
            top: 0;
            left: 0;
            width: 75%;
            max-width: 300px;
            height: 100%;
            background-color: var(--bg-main);
            box-shadow: 2px 0 15px var(--shadow-medium);
            z-index: 199;
            transform: translateX(-100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
        }
        #chat-sidebar.visible {
            transform: translateX(0);
        }
        .sidebar-header {
            padding: 15px;
            padding-top: calc(15px + env(safe-area-inset-top));
            font-size: 18px;
            font-weight: 600;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }
        .sidebar-content {
            padding: 20px;
            flex-grow: 1;
            overflow-y: auto;
        }
        .sidebar-item {
            margin-bottom: 20px;
        }
        .sidebar-item label {
            font-weight: 500;
            font-size: 14px;
            color: var(--text-secondary);
        }
        .sidebar-item .value {
            font-size: 20px;
            font-weight: bold;
            color: var(--accent-secondary);
        }
        #sidebar-preview-content {
            background-color: var(--bg-soft);
            border-radius: 8px;
            padding: 10px;
            font-size: 12px;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 40vh;
            overflow-y: auto;
            margin-top: 10px;
            display: none;
        }
        
        /* System Prompt Toggle Switch */
        .toggle-switch { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
        .toggle-switch label { font-size: 16px; }
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--accent-primary); transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent-secondary); }
        input:checked + .slider:before { transform: translateX(20px); }

        /* Ledger Filter Modals */
        #ledger-month-filter-modal .modal-body, #ledger-category-filter-modal .modal-body { padding: 0; }
        .filter-list { max-height: 50vh; overflow-y: auto; }
        .filter-item { display: flex; align-items: center; padding: 12px 15px; border-bottom: 1px solid var(--border-color); cursor: pointer; }
        .filter-item:last-child { border-bottom: none; }
        .filter-item input[type="checkbox"] { margin-right: 12px; width: 18px; height: 18px; accent-color: var(--accent-secondary); }
        .filter-item label { flex-grow: 1; }
        .filter-tabs { display: flex; border-bottom: 1px solid var(--border-color); }
        .filter-tab { flex: 1; padding: 12px; text-align: center; cursor: pointer; background-color: var(--bg-soft); color: var(--text-secondary); }
        .filter-tab.active { background-color: var(--bg-main); color: var(--text-primary); font-weight: bold; }
    </style>
</head>
<body data-theme="default">
    <div id="app-container">
        <div id="sidebar-overlay"></div>
        <div id="chat-sidebar">
            <div class="sidebar-header">ËÅäÂ§©Âä©Êâã</div>
            <div class="sidebar-content">
                <div class="sidebar-item">
                    <label>ÂΩìÂâç‰∏ä‰∏ãÊñá Tokens</label>
                    <div id="sidebar-token-count" class="value">0</div>
                </div>
                <button class="form-button secondary" id="preview-context-btn">È¢ÑËßà‰∏ä‰∏ãÊñá</button>
                <pre id="sidebar-preview-content"></pre>
            </div>
        </div>

        <div class="main-content">
            <!-- Page 1: Accounting (Chat) -->
            <div id="accounting-screen" class="page active">
                <div class="header">
                    <div class="left-action"><span class="action-btn" id="chat-settings-btn">‚â°</span></div>
                    <div class="center-title"><span id="chat-header-title">ÊàëÁöÑËÆ∞‰∫ãÊú¨</span></div>
                    <div class="right-action"></div>
                </div>
                <div id="chat-messages"></div>
                <div id="selection-action-bar">
                    <button id="delete-selected-btn">Âà†Èô§</button>
                    <button id="cancel-selection-btn">ÂèñÊ∂à</button>
                </div>
                <div id="plus-menu">
                    <button id="add-transaction-btn">üí∞ ËÆ∞‰∏ÄÁ¨î</button>
                    <button id="add-schedule-btn">üè∑Ô∏è ÂÆö‰∏™‰∫ã</button>
                </div>
                <div id="chat-input-area">
                    <button class="chat-action-btn" id="plus-btn">‚ûï</button>
                    <button class="chat-action-btn" id="ai-trigger-btn">ü§ñ</button>
                    <button class="chat-action-btn" id="image-upload-btn">üñºÔ∏è</button>
                    <input type="file" id="image-upload-input" accept="image/*" style="display:none;">
                    <textarea id="chat-input" rows="1" placeholder="ËØ¥ÁÇπ‰ªÄ‰πà..."></textarea>
                    <button id="send-btn" disabled>ÂèëÈÄÅ</button>
                </div>
            </div>

            <!-- Page 2: Ledger -->
            <div id="ledger-screen" class="page">
                 <div class="header">
                    <div class="left-action"></div>
                    <div class="center-title"><span>ÊàëÁöÑË¥¶Êú¨</span></div>
                    <div class="right-action"><span class="action-btn" id="forward-ledger-btn">‚û£</span></div>
                 </div>
                <div class="ledger-controls">
                    <button class="filter-btn" id="ledger-month-filter-btn">Êúà‰ªΩÁ≠õÈÄâ</button>
                    <button class="filter-btn" id="ledger-category-filter-btn">ÂàÜÁ±ªÁ≠õÈÄâ</button>
                    <select id="ledger-sort"><option value="time_desc">Êó∂Èó¥ÂÄíÂ∫è</option><option value="time_asc">Êó∂Èó¥Ê≠£Â∫è</option><option value="amount_desc">ÈáëÈ¢ùÂÄíÂ∫è</option><option value="amount_asc">ÈáëÈ¢ùÊ≠£Â∫è</option></select>
                </div>
                <div class="page-content" id="ledger-page-content">
                    <div id="ledger-view-wrapper">
                        <div id="ledger-list-view">
                            <ul id="ledger-list"></ul>
                            <div id="ledger-summary"></div>
                        </div>
                        <div id="ledger-chart-view">
                            <div id="pie-chart-tooltip"></div>
                            <div class="pie-chart-area">
                                <div class="pie-chart-title-wrapper">
                                    <p class="pie-chart-subtitle" id="expense-pie-subtitle"></p>
                                    <h3 class="pie-chart-title">ÊîØÂá∫</h3>
                                </div>
                                <svg id="expense-pie-chart"></svg>
                                <div class="pie-legend" id="expense-pie-legend"></div>
                            </div>
                            <div class="pie-chart-area">
                                <div class="pie-chart-title-wrapper">
                                    <p class="pie-chart-subtitle" id="income-pie-subtitle"></p>
                                    <h3 class="pie-chart-title">Êî∂ÂÖ•</h3>
                                </div>
                                <svg id="income-pie-chart"></svg>
                                <div class="pie-legend" id="income-pie-legend"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="ledger-footer-controls">
                    <select id="ledger-currency"></select>
                    <button id="toggle-ledger-view-btn">üìä</button>
                </div>
            </div>

            <!-- Page 3: Schedule -->
            <div id="schedule-screen" class="page">
                <div class="header">
                    <div class="left-action"></div>
                    <div class="center-title"><span>ÊàëÁöÑÊó•Á®ã</span></div>
                    <div class="right-action"><span class="action-btn" id="forward-schedule-btn">‚û£</span></div>
                </div>
                <div class="page-content">
                    <div class="schedule-section">
                        <div class="schedule-section-title">ÂæÖÂÆåÊàê</div>
                        <div class="schedule-quadrant" id="quadrant-1">
                            <div class="quadrant-header">
                                <div class="quadrant-title">ÈáçË¶Å‰∏îÁ¥ßÊÄ•</div>
                            </div>
                            <div class="schedule-items" id="quadrant-1-items"></div>
                        </div>
                        <div class="schedule-quadrant" id="quadrant-2">
                            <div class="quadrant-header">
                                <div class="quadrant-title">ÈáçË¶Å‰∏çÁ¥ßÊÄ•</div>
                            </div>
                            <div class="schedule-items" id="quadrant-2-items"></div>
                        </div>
                        <div class="schedule-quadrant" id="quadrant-3">
                            <div class="quadrant-header">
                                <div class="quadrant-title">Á¥ßÊÄ•‰∏çÈáçË¶Å</div>
                            </div>
                            <div class="schedule-items" id="quadrant-3-items"></div>
                        </div>
                        <div class="schedule-quadrant" id="quadrant-4">
                            <div class="quadrant-header">
                                <div class="quadrant-title">‰∏çÁ¥ßÊÄ•‰∏çÈáçË¶Å</div>
                            </div>
                            <div class="schedule-items" id="quadrant-4-items"></div>
                        </div>
                    </div>
                    <div class="schedule-section">
                        <div class="schedule-section-title">Â∑≤ÂÆåÊàê</div>
                        <div class="schedule-items" id="completed-items"></div>
                    </div>
                </div>
            </div>

            <!-- Page 4: More/Settings -->
            <div id="more-screen" class="page">
                <div class="header">
                    <div class="left-action"></div>
                    <div class="center-title"><span>ËÆæÁΩÆ</span></div>
                    <div class="right-action"></div>
                </div>
                <div class="page-content">
                    <div class="setting-group">
                        <div class="setting-group-title">Â§ñËßÇËÆæÁΩÆ</div>
                        <div class="form-group">
                            <label>‰∏ªÈ¢òÈÄâÊã©</label>
                            <div class="theme-selector">
                                <label class="theme-option"><input type="radio" name="theme" value="default" checked><div class="swatch default"></div><span class="label">ÊöñÈò≥ÁîúÊùè</span></label>
                                <label class="theme-option"><input type="radio" name="theme" value="blue"><div class="swatch blue"></div><span class="label">Êô¥Á©∫ËãèÊâì</span></label>
                                <label class="theme-option"><input type="radio" name="theme" value="green"><div class="swatch green"></div><span class="label">ËñÑËç∑ÂæÆÈ£é</span></label>
                                <label class="theme-option"><input type="radio" name="theme" value="purple"><div class="swatch purple"></div><span class="label">Á¥´Ëó§ÂπªÊ¢¶</span></label>
                                <label class="theme-option"><input type="radio" name="theme" value="pink"><div class="swatch pink"></div><span class="label">Ê®±ËêΩÊòüËæ∞</span></label>
                                <label class="theme-option"><input type="radio" name="theme" value="gray"><div class="swatch gray"></div><span class="label">ÈùôË∞ß‰π¶ÂΩ±</span></label>
                            </div>
                        </div>
                        <div class="form-group"><label>ËÅäÂ§©ËÉåÊôØ</label><div class="avatar-upload"><button onclick="document.getElementById('setting-chat-bg-input').click()">‰∏ä‰º†</button><button id="remove-bg-btn" style="background-color: var(--expense-color); color: white;">ÁßªÈô§ËÉåÊôØ</button><input type="file" id="setting-chat-bg-input" accept="image/*"></div></div>
                    </div>
                    <div class="setting-group">
                        <div class="setting-group-title">ÊàëÁöÑËµÑÊñô</div>
                        <div class="form-group"><label>Áæ§ËÅäÂêçÁß∞</label><input type="text" id="setting-chat-name"></div>
                        <div class="form-group"><label>Â§¥ÂÉè</label><div class="avatar-upload"><img id="setting-chat-avatar-preview"><button id="upload-user-avatar-btn">‰∏ä‰º†</button><input type="file" id="setting-chat-avatar-input" accept="image/*"></div></div>
                        <div class="form-group"><label>ID</label><input type="text" id="setting-user-id" placeholder="ÂèØÈÄâÂ°´"></div>
                        <div class="form-group"><label>ÊÄßÂà´</label><select id="setting-user-gender"><option value="">Êú™ËÆæÁΩÆ</option><option value="male">Áî∑</option><option value="female">Â•≥</option></select></div>
                        <div class="form-group"><label>‰∏™‰∫∫ËØ¥Êòé</label><textarea id="setting-user-bio" placeholder="ÂèØÈÄâÂ°´"></textarea></div>
                    </div>
                    <div class="setting-group">
                        <div class="setting-group-title">AI ËÆæÁΩÆ</div>
                        <div class="form-group"><label for="max-tokens-input">ÊúÄÂ§ß‰∏ä‰∏ãÊñáÈïøÂ∫¶ (Token)</label><input type="number" id="max-tokens-input" placeholder="Âª∫ËÆÆ 4000-8000"></div>
                        <p style="font-size:12px; color: var(--text-secondary); margin-top:-10px; margin-bottom: 15px;">Ê≠§ËÆæÁΩÆÁî®‰∫éÈôêÂà∂ÂèëÈÄÅÁªôAIÁöÑËÅäÂ§©ËÆ∞ÂΩïÈïøÂ∫¶ÔºåÈò≤Ê≠¢Ë∂ÖÂá∫Ê®°ÂûãÈôêÂà∂„ÄÇ1‰∏™Ê±âÂ≠óÁ∫¶Á≠â‰∫é2‰∏™Token„ÄÇ</p>
                        <button class="form-button secondary" id="manage-system-prompts-btn">ÁÆ°ÁêÜÁ≥ªÁªüÊèêÁ§∫ËØç</button>
                        <button class="form-button secondary" id="manage-proxies-btn">ÁÆ°ÁêÜAPIÂèç‰ª£</button>
                        <button class="form-button secondary" id="manage-characters-btn">ÁÆ°ÁêÜAIËßíËâ≤</button>
                    </div>
                    <div class="setting-group">
                        <div class="setting-group-title">Â∏ÅÁßçËÆæÁΩÆ</div>
                        <button class="form-button secondary" id="manage-currencies-btn">ÁÆ°ÁêÜÂ∏ÅÁßçÂíåÊ±áÁéá</button>
                    </div>
                     <div class="setting-group">
                        <div class="setting-group-title">ËÆ∞ÂΩïÁÆ°ÁêÜ</div>
                        <button class="form-button secondary" id="export-json-btn">ÂØºÂá∫‰∏∫ JSON</button>
                        <button class="form-button secondary" id="import-json-btn">‰ªé JSON ÂØºÂÖ•</button>
                        <input type="file" id="import-json-input" accept=".json" style="display:none;">
                        <button class="form-button secondary" id="export-txt-btn">ÂØºÂá∫‰∏∫ TXT</button>
                    </div>
                     <p style="text-align: center; margin-top: 20px; font-size: 12px; color: var(--text-secondary);">Technical support from Cava, Claude & Gemini</p>
                </div>
            </div>
        </div>

        <!-- Transaction Input Panel -->
        <div id="transaction-panel">
            <div class="panel-header">
                <span class="close-btn" id="close-transaction-panel">√ó</span>
                <span style="font-weight: 600;" id="transaction-panel-title">Êñ∞Âª∫ËÆ∞Ë¥¶</span>
            </div>
            <div id="amount-display-container"><span id="currency-selector">RMB</span><div id="amount-display">0.00</div></div>
            <div class="type-selector"><button id="type-expense-btn" class="active">ÊîØÂá∫</button><button id="type-income-btn">Êî∂ÂÖ•</button></div>
            <div id="category-selector"></div>
            <div class="transaction-remark-section">
                <input type="text" id="transaction-remark-input" placeholder="Ê∑ªÂä†Â§áÊ≥®ÔºàÂèØÈÄâÔºâ">
            </div>
            <div id="numpad-container">
                <div class="numpad"><button data-key="1">1</button><button data-key="2">2</button><button data-key="3">3</button><button data-key="4">4</button><button data-key="5">5</button><button data-key="6">6</button><button data-key="7">7</button><button data-key="8">8</button><button data-key="9">9</button><button class="zero" data-key="0">0</button><button data-key=".">.</button></div>
                <div class="numpad-actions"><button id="numpad-delete">‚å´</button><button id="numpad-confirm" class="confirm">ÂÆåÊàê</button></div>
            </div>
        </div>

        <!-- Schedule Input Panel -->
        <div id="schedule-panel">
            <div class="panel-header">
                <span class="close-btn" id="close-schedule-panel">√ó</span>
                <span style="font-weight: 600;" id="schedule-panel-title">Êñ∞Âª∫Êó•Á®ã</span>
            </div>
            <div class="schedule-form">
                <div class="schedule-form-section red">
                    <label>‰∫ãÈ°πÁ±ªÂà´</label>
                    <div class="event-type-toggle">
                        <button id="schedule-type-once" class="active">ÂçïÊ¨°‰∫ã‰ª∂</button>
                        <button id="schedule-type-long">ÈïøÊúü‰∫ã‰ª∂</button>
                    </div>
                </div>
                 <div class="schedule-form-section blue">
                    <label>Ê†áÈ¢ò</label>
                    <input type="text" id="schedule-title-input" placeholder="ËæìÂÖ•‰∫ã‰ª∂Ê†áÈ¢ò">
                </div>
                <div class="schedule-form-section pink">
                    <label>ÈáçË¶ÅÁ®ãÂ∫¶</label>
                    <div class="importance-stars" id="importance-stars">
                        <span class="star" data-value="1">‚òÖ</span>
                        <span class="star" data-value="2">‚òÖ</span>
                        <span class="star" data-value="3">‚òÖ</span>
                        <span class="star" data-value="4">‚òÖ</span>
                        <span class="star" data-value="5">‚òÖ</span>
                        <span class="importance-score" id="importance-score">0.0</span>
                    </div>
                </div>
                <div class="schedule-form-section purple">
                    <label>Êà™Ê≠¢Êó•Êúü</label>
                    <div class="deadline-inputs">
                        <span id="deadline-display-text">ÈÄâÊã©Êó•Êúü</span>
                        <div class="time-input-part">
                            <input type="number" id="deadline-hour-input" class="time-input" placeholder="Êó∂">
                            <span class="time-separator">:</span>
                            <input type="number" id="deadline-minute-input" class="time-input" placeholder="ÂàÜ">
                        </div>
                    </div>
                </div>
                <div class="schedule-form-section blue">
                    <label>ÂÖ∑‰ΩìËØ¥Êòé</label>
                    <textarea id="schedule-description-input" placeholder="ËæìÂÖ•ÂÖ∑‰ΩìËØ¥ÊòéÔºàÂèØÈÄâÔºâ"></textarea>
                </div>
            </div>
            <div class="schedule-actions">
                <button class="cancel-btn" id="cancel-schedule-btn">ÂèñÊ∂à</button>
                <button class="confirm-btn" id="confirm-schedule-btn">Á°ÆÂÆö</button>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <div id="bottom-nav">
            <div class="nav-item active" data-page="accounting-screen"><div class="icon">üí¨</div><div class="label">ËÆ∞‰∫ã</div></div>
            <div class="nav-item" data-page="ledger-screen"><div class="icon">üìñ</div><div class="label">Ë¥¶Êú¨</div></div>
            <div class="nav-item" data-page="schedule-screen"><div class="icon">üóìÔ∏è</div><div class="label">Êó•Á®ã</div></div>
            <div class="nav-item" data-page="more-screen"><div class="icon">‚öôÔ∏è</div><div class="label">ËÆæÁΩÆ</div></div>
        </div>
    </div>

    <!-- Modals -->
    <div id="calendar-modal" class="modal-overlay"><div class="modal-content"><div class="modal-body"><div class="calendar-header"><button id="prev-month-btn">&lt;</button><span id="calendar-month-year" class="calendar-month-year"></span><button id="next-month-btn">&gt;</button></div><div class="calendar-weekdays"><span>Êó•</span><span>‰∏Ä</span><span>‰∫å</span><span>‰∏â</span><span>Âõõ</span><span>‰∫î</span><span>ÂÖ≠</span></div><div class="calendar-grid" id="calendar-grid"></div></div><div class="modal-footer"><button class="cancel-btn" id="clear-date-btn">Ê∏ÖÈô§Êó•Êúü</button><button class="cancel-btn" id="close-calendar-btn">ÂÖ≥Èó≠</button></div></div></div>
    <div id="api-proxy-modal" class="modal-overlay"><div class="modal-content"><div class="modal-header">ÁÆ°ÁêÜAPIÂèç‰ª£</div><div class="modal-body"><div id="proxy-list"></div><button class="form-button" id="add-proxy-btn">Ôºã Ê∑ªÂä†Êñ∞Âèç‰ª£</button></div><div class="modal-footer"><button class="cancel-btn" id="close-proxy-modal">ÂÖ≥Èó≠</button></div></div></div>
    <div id="proxy-editor-modal" class="modal-overlay"><div class="modal-content"><div class="modal-header" id="proxy-editor-title">ÁºñËæëÂèç‰ª£</div><div class="modal-body"><div class="form-group"><label>Ëá™ÂÆö‰πâÂêçÁß∞</label><input type="text" id="proxy-editor-name" placeholder="Â¶Ç CavaÁöÑAPI"></div><div class="form-group"><label>URL (Êó†ÈúÄ /v1)</label><input type="text" id="proxy-editor-url"></div><div class="form-group"><label>API Key</label><input type="password" id="proxy-editor-apikey"></div><div class="form-group"><label>Model(s) (Êç¢Ë°åÂàÜÈöî)</label><textarea id="proxy-editor-models" rows="3" placeholder="gpt-4o&#10;claude-3-opus-20240229"></textarea></div></div><div class="modal-footer"><button class="cancel-btn">ÂèñÊ∂à</button><button class="save-btn">‰øùÂ≠ò</button></div></div></div>
    <div id="ai-character-modal" class="modal-overlay"><div class="modal-content"><div class="modal-header">ÁÆ°ÁêÜAIËßíËâ≤</div><div class="modal-body"><div id="character-list"></div><button class="form-button" id="add-character-btn">Ôºã Ê∑ªÂä†Êñ∞ËßíËâ≤</button></div><div class="modal-footer"><button class="cancel-btn" id="close-character-modal">ÂÖ≥Èó≠</button></div></div></div>
    <div id="character-editor-modal" class="modal-overlay"><div class="modal-content"><div class="modal-header" id="character-editor-title">ÁºñËæëËßíËâ≤</div><div class="modal-body"><div class="form-group"><label>ËßíËâ≤ÂêçÁß∞</label><input type="text" id="character-editor-name"></div><div class="form-group"><label>ËßíËâ≤Â§¥ÂÉè</label><div class="avatar-upload"><img id="character-editor-avatar-preview"><button id="upload-char-avatar-btn">‰∏ä‰º†</button><input type="file" id="character-editor-avatar-input" accept="image/*"></div></div><div class="form-group"><label>Prompt (‰∫∫ËÆæ)</label><textarea id="character-editor-prompt" rows="5"></textarea></div><div class="form-group"><label>‰∏ªÁî®API</label><select id="character-editor-proxy"></select></div><div class="form-group"><label>‰∏ªÁî®Ê®°Âûã</label><select id="character-editor-model"></select></div><div class="form-group"><label>Â§áÁî®API (ÂèØÈÄâ)</label><select id="character-editor-backup-proxy"></select></div><div class="form-group"><label>Â§áÁî®Ê®°Âûã</label><select id="character-editor-backup-model"></select></div></div><div class="modal-footer"><button class="cancel-btn">ÂèñÊ∂à</button><button class="save-btn">‰øùÂ≠ò</button></div></div></div>
    <div id="ai-character-selector-modal" class="modal-overlay"><div class="modal-content"><div class="modal-header">ÈÄâÊã©ÂèëË®ÄËßíËâ≤</div><div class="modal-body" id="ai-character-selector"></div><div class="modal-footer"><button class="cancel-btn">ÂèñÊ∂à</button></div></div></div>
    <div id="message-action-menu" class="modal-overlay"><div class="modal-content"><div class="modal-body"><button id="multi-select-btn">‚òëÔ∏è Â§öÈÄâ</button><button id="edit-message-btn">‚úèÔ∏è ÁºñËæë</button><button id="edit-ai-message-btn">‚úèÔ∏è ÁºñËæë</button><button id="copy-message-btn">üìã Â§çÂà∂</button><button id="delete-message-btn" class="danger">üóëÔ∏è Âà†Èô§</button></div><div class="modal-footer" style="padding-top:0;"><button class="cancel-btn" style="width:100%;">ÂèñÊ∂à</button></div></div></div>
    <div id="schedule-detail-modal" class="modal-overlay"><div class="modal-content"><div class="modal-header">Êó•Á®ãËØ¶ÊÉÖ</div><div class="modal-body"><div class="detail-row"><div class="detail-label">Ê†áÈ¢ò</div><div class="detail-value" id="detail-title"></div></div><div class="detail-row"><div class="detail-label">ËØ¥Êòé</div><div class="detail-value" id="detail-description"></div></div><div class="detail-row"><div class="detail-label">ÈáçË¶ÅÁ®ãÂ∫¶</div><div class="detail-value" id="detail-importance"></div></div><div class="detail-row"><div class="detail-label">Êà™Ê≠¢Êó•Êúü</div><div class="detail-value" id="detail-deadline"></div></div><div class="detail-row"><div class="detail-label">‰∫ã‰ª∂Á±ªÂûã</div><div class="detail-value" id="detail-type"></div></div></div><div class="modal-footer"><button class="cancel-btn" id="edit-schedule-btn">ÁºñËæë</button><button class="cancel-btn" style="background-color: var(--expense-color); color: white;" id="delete-schedule-btn">Âà†Èô§</button><button class="cancel-btn" id="close-schedule-detail-modal">ÂÖ≥Èó≠</button></div></div></div>
    <div id="cropper-modal" class="modal-overlay"><div class="modal-content"><div class="modal-header">Ë£ÅÂâ™Â§¥ÂÉè</div><div class="modal-body"><div id="cropper-image-container"><img id="cropper-image"></div></div><div class="modal-footer"><button class="cancel-btn">ÂèñÊ∂à</button><button class="save-btn">Á°ÆÂÆö</button></div></div></div>
    <div id="currency-list-modal" class="modal-overlay"><div class="modal-content"><div class="modal-header">ÁÆ°ÁêÜÂ∏ÅÁßç</div><div class="modal-body"><div id="currency-list"></div><button class="form-button" id="add-currency-btn">Ôºã Ê∑ªÂä†Êñ∞Â∏ÅÁßç</button></div><div class="modal-footer"><button class="cancel-btn" id="close-currency-list-modal">ÂÖ≥Èó≠</button></div></div></div>
    <div id="currency-editor-modal" class="modal-overlay"><div class="modal-content"><div class="modal-header" id="currency-editor-title">ÁºñËæëÂ∏ÅÁßç</div><div class="modal-body"><div class="form-group"><label>Â∏ÅÁßç‰ª£Á†Å (3‰ΩçÂ§ßÂÜôÂ≠óÊØç)</label><input type="text" id="currency-editor-code" placeholder="‰æãÂ¶Ç: HKD, USD" maxlength="3" style="text-transform:uppercase;"></div><div class="form-group"><label>Â∏ÅÁßçÂêçÁß∞</label><input type="text" id="currency-editor-name" placeholder="‰æãÂ¶Ç: Ê∏ØÂ∏Å, ÁæéÂÖÉ"></div><div class="form-group"><label>ÂØπ RMB ÁöÑÊ±áÁéá (1 Â∏ÅÁßç = ? RMB)</label><input type="number" id="currency-editor-rate" placeholder="‰æãÂ¶Ç: 0.92"></div></div><div class="modal-footer"><button class="cancel-btn">ÂèñÊ∂à</button><button class="save-btn">‰øùÂ≠ò</button></div></div></div>
    <div id="system-prompts-modal" class="modal-overlay"><div class="modal-content"><div class="modal-header">ÁÆ°ÁêÜÁ≥ªÁªüÊèêÁ§∫ËØç</div><div class="modal-body"><div class="setting-group" style="margin-bottom: 15px;"><div class="setting-group-title" style="margin-bottom: 10px;">ÈôÑÂä†‰ø°ÊÅØ</div><div class="toggle-switch"><label for="system-prompt-send-time">ÂèëÈÄÅÂΩìÂâçÊó∂Èó¥</label><label class="switch"><input type="checkbox" id="system-prompt-send-time"><span class="slider"></span></label></div><div class="toggle-switch"><label for="system-prompt-send-model">ÂèëÈÄÅÂΩìÂâçÊ®°Âûã</label><label class="switch"><input type="checkbox" id="system-prompt-send-model"><span class="slider"></span></label></div><div class="toggle-switch"><label for="system-prompt-send-role">ÂèëÈÄÅAIËßíËâ≤Âêç</label><label class="switch"><input type="checkbox" id="system-prompt-send-role"><span class="slider"></span></label></div></div><div class="setting-group"><div class="setting-group-title">ÂêåÊ≠•ÊèêÁ§∫ËØçÊ®°Êùø</div><div class="form-group" style="margin-bottom: 10px;"><label for="system-prompt-ledger">ÂêåÊ≠•Ë¥¶Êú¨</label><textarea id="system-prompt-ledger" rows="2"></textarea></div><div class="form-group" style="margin-bottom: 10px;"><label for="system-prompt-schedule">ÂêåÊ≠•Êó•Á®ã</label><textarea id="system-prompt-schedule" rows="2"></textarea></div><div class="form-group"><label for="system-prompt-pie">ÂêåÊ≠•ÂõæË°®</label><textarea id="system-prompt-pie" rows="2"></textarea></div></div></div><div class="modal-footer"><button class="cancel-btn">ÂèñÊ∂à</button><button class="save-btn">‰øùÂ≠ò</button></div></div></div>
    <div id="ledger-month-filter-modal" class="modal-overlay"><div class="modal-content"><div class="modal-header">ÈÄâÊã©Êúà‰ªΩ</div><div class="modal-body"><div class="filter-list" id="month-filter-list"></div></div><div class="modal-footer"><button class="cancel-btn">ÂèñÊ∂à</button><button class="save-btn">Á°ÆÂÆö</button></div></div></div>
    <div id="ledger-category-filter-modal" class="modal-overlay"><div class="modal-content"><div class="modal-header">ÈÄâÊã©ÂàÜÁ±ª</div><div class="modal-body"><div class="filter-tabs"><div class="filter-tab active" data-type="expense">ÊîØÂá∫</div><div class="filter-tab" data-type="income">Êî∂ÂÖ•</div></div><div class="filter-list" id="category-filter-list"></div></div><div class="modal-footer"><button class="cancel-btn">ÂèñÊ∂à</button><button class="save-btn">Á°ÆÂÆö</button></div></div></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const db = new Dexie('WarmBookkeepingDB_v8');
        db.version(8).stores({
            appConfig: 'id',
            transactions: '++id, timestamp, type, category, amount, currency, remark',
            messages: '++id, timestamp, role, content, type, senderId, relatedId',
            apiProxies: '++id, name, url, apiKey, models',
            aiCharacters: '++id, name, prompt, avatar, proxyId, model, backupProxyId, backupModel',
            currencies: 'code, name, rate',
            schedules: '++id, timestamp, title, description, importance, deadline, eventType, completed'
        });

        const DEFAULT_SYSTEM_PROMPTS = {
            sendTime: true,
            sendModel: true,
            sendRole: true,
            ledger: 'ËøôÊòØÊàëÁöÑËÆ∞Ë¥¶Êù°ÁõÆÊï∞ÊçÆÔºåËØ∑‰Ω†Â∏ÆÊàëÂàÜÊûê‰∏Ä‰∏ãÔºö{data}',
            schedule: 'ËøôÊòØÊàëÁöÑÊó•Á®ãÊï∞ÊçÆÔºåËØ∑‰Ω†Â∏ÆÊàëÂàÜÊûê‰∏Ä‰∏ãÔºö{data}',
            pie: 'ËøôÊòØÊàëË¥¶Êú¨ÂõæË°®Êï∞ÊçÆÔºåËØ∑‰Ω†Â∏ÆÊàëÂàÜÊûê‰∏Ä‰∏ãÔºö{data}'
        };

        let state = {
            config: {}, proxies: [], characters: [], messages: [], transactions: [], currencies: [], schedules: [],
            currentTransaction: { type: 'expense', category: null, amountStr: '0', currency: 'RMB' },
            currentSchedule: {},
            calendarState: { year: new Date().getFullYear(), month: new Date().getMonth(), selectedDate: null },
            ledgerFilters: { months: [], type: 'expense', categories: [] },
            isSelectionMode: false,
            selectedMessages: new Set(),
            currentlyEditingMsgId: null,
            currentlyEditingTransactionId: null,
            currentlyEditingScheduleId: null,
        };
        
        const ELS = {
            body: document.body,
            app: document.getElementById('app-container'), pages: document.querySelectorAll('.page'), navItems: document.querySelectorAll('.nav-item'),
            chatHeaderTitle: document.getElementById('chat-header-title'), chatAvatar: document.getElementById('setting-chat-avatar-preview'),
            chatMessages: document.getElementById('chat-messages'), chatInput: document.getElementById('chat-input'), sendBtn: document.getElementById('send-btn'),
            accountingScreen: document.getElementById('accounting-screen'), transactionPanel: document.getElementById('transaction-panel'),
            schedulePanel: document.getElementById('schedule-panel'),
            amountDisplay: document.getElementById('amount-display'), categorySelector: document.getElementById('category-selector'),
            ledgerList: document.getElementById('ledger-list'), ledgerSummary: document.getElementById('ledger-summary'),
            ledgerSort: document.getElementById('ledger-sort'),
            ledgerCurrency: document.getElementById('ledger-currency'),
            themeSelectors: document.querySelectorAll('input[name="theme"]'),
            sidebar: document.getElementById('chat-sidebar'),
            sidebarOverlay: document.getElementById('sidebar-overlay'),
            chatSettingsBtn: document.getElementById('chat-settings-btn'),
            sidebarTokenCount: document.getElementById('sidebar-token-count'),
            previewContextBtn: document.getElementById('preview-context-btn'),
            sidebarPreviewContent: document.getElementById('sidebar-preview-content'),
            plusMenu: document.getElementById('plus-menu'),
        };

        const CATEGORIES = {
            expense: [ { id: 'food', name: 'È§êÈ•ÆÁæéÈ£ü', icon: 'üçî' }, { id: 'shopping', name: 'Ë¥≠Áâ©Ê∂àË¥π', icon: 'üõçÔ∏è' }, { id: 'transport', name: '‰∫§ÈÄöÂá∫Ë°å', icon: 'üöå' }, { id: 'entertainment', name: 'ÊñáÂåñÂ®±‰πê', icon: 'üé¨' }, { id: 'games', name: 'Ê∏∏ÊàèÁõ∏ÂÖ≥', icon: 'üéÆ' }, { id: 'housing', name: 'Â±ÖÂÆ∂ÁîüÊ¥ª', icon: 'üè†' }, { id: 'medical', name: 'ÂåªÁñóÂÅ•Â∫∑', icon: 'üíä' }, { id: 'social', name: '‰∫∫ÊÉÖÂæÄÊù•', icon: 'üéÅ' }, { id: 'study', name: 'Â≠¶‰π†ÊèêÂçá', icon: 'üìö' }, { id: 'other', name: 'ÂÖ∂‰ªñÊîØÂá∫', icon: 'üí∏' }, ],
            income: [ { id: 'salary', name: 'Â∑•ËµÑ', icon: 'üíº' }, { id: 'bonus', name: 'Â•ñÈáë', icon: 'üßß' }, { id: 'investment', name: 'ÁêÜË¥¢', icon: 'üìà' }, { id: 'part-time', name: 'ÂÖºËÅå', icon: 'üí™' }, { id: 'other', name: 'ÂÖ∂‰ªñÊî∂ÂÖ•', icon: 'üí∞' }, ]
        };
        const DEFAULT_AVATAR = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iNTAiIGN5PSI1MCIgcj0iNTAiIGZpbGw9IiNGQUUxRDUiLz48cGF0aCBkPSJNNzIgMzVBNiA2IDAgMSAwIDYwIDM1IDYgNiAwIDAgMCA3MiAzNW0tNDQgMEE2IDYgMCAxIDAgMTYgMzUgNiA2IDAgMCAwIDI4IDM1TTMzIDYwYTQwIDQwIDAgMCAwIDM0IDBjLTEuNS05LTcuNS0xNS0xNy0xNVMzNC41IDUxIDMzIDYwWiIgZmlsbD0iIzhDN0I3MyIvPjwvc3ZnPg==';

        async function init() {
            await loadDataFromDB();
            setupEventListeners();
            navigateTo('accounting-screen');
            renderChatMessages();
            renderLedger();
            renderSchedules();
            applyConfigToUI();
            updateSendButtonState();
            populateLedgerCurrencyFilter();
        }

        async function loadDataFromDB() {
            const [config, proxies, characters, messages, transactions, currencies, schedules] = await Promise.all([
                db.appConfig.get('main'), db.apiProxies.toArray(), db.aiCharacters.toArray(), db.messages.orderBy('timestamp').toArray(), db.transactions.orderBy('timestamp').toArray(), db.currencies.toArray(), db.schedules.toArray(),
            ]);
            const baseConfig = { id: 'main', chatName: 'CavaËÆ∞‰∫ãÊú¨1.0beta', chatAvatar: DEFAULT_AVATAR, maxTokens: 4096, background: '', theme: 'default', userId: '', userGender: '', userBio: '', systemPromptSettings: DEFAULT_SYSTEM_PROMPTS };
            state.config = { ...baseConfig, ...config, systemPromptSettings: { ...DEFAULT_SYSTEM_PROMPTS, ...(config ? config.systemPromptSettings : {}) } };
            state.proxies = proxies; state.characters = characters; state.messages = messages; state.transactions = transactions; state.schedules = schedules || [];
            
            if (currencies.length === 0) {
                const preset = { code: 'HKD', name: 'Ê∏ØÂ∏Å', rate: 0.92 };
                await db.currencies.put(preset);
                state.currencies = [preset];
            } else {
                state.currencies = currencies;
            }
        }

        function applyConfigToUI() {
            ELS.chatHeaderTitle.textContent = state.config.chatName;
            document.getElementById('setting-chat-name').value = state.config.chatName;
            ELS.chatAvatar.src = state.config.chatAvatar || DEFAULT_AVATAR;
            document.getElementById('max-tokens-input').value = state.config.maxTokens;
            ELS.body.dataset.theme = state.config.theme || 'default';
            const themeRadio = document.querySelector(`input[name="theme"][value="${state.config.theme || 'default'}"]`);
            if (themeRadio) themeRadio.checked = true;
            ELS.accountingScreen.style.backgroundImage = state.config.background ? `url(${state.config.background})` : 'none';
            document.getElementById('setting-user-id').value = state.config.userId || '';
            document.getElementById('setting-user-gender').value = state.config.userGender || '';
            document.getElementById('setting-user-bio').value = state.config.userBio || '';
        }
        
        async function updateConfig(key, value) {
            state.config[key] = value;
            await db.appConfig.put(state.config);
            applyConfigToUI();
        }

        function navigateTo(pageId) { 
            ELS.pages.forEach(p => p.classList.remove('active')); 
            document.getElementById(pageId)?.classList.add('active'); 
            ELS.navItems.forEach(item => item.classList.toggle('active', item.dataset.page === pageId)); 
            if (pageId === 'ledger-screen') renderLedger(); 
            if (pageId === 'schedule-screen') renderSchedules();
        }

        function setupEventListeners() {
            ELS.navItems.forEach(item => item.addEventListener('click', () => navigateTo(item.dataset.page)));
            
            // Auto-saving settings
            document.getElementById('setting-chat-name').addEventListener('input', e => updateConfig('chatName', e.target.value));
            document.getElementById('setting-user-id').addEventListener('input', e => updateConfig('userId', e.target.value));
            document.getElementById('setting-user-gender').addEventListener('change', e => updateConfig('userGender', e.target.value));
            document.getElementById('setting-user-bio').addEventListener('input', e => updateConfig('userBio', e.target.value));
            document.getElementById('max-tokens-input').addEventListener('change', e => updateConfig('maxTokens', parseInt(e.target.value) || 4096));
            ELS.themeSelectors.forEach(radio => radio.addEventListener('change', (e) => {
                ELS.body.dataset.theme = e.target.value;
                updateConfig('theme', e.target.value);
            }));

            document.getElementById('upload-user-avatar-btn').addEventListener('click', () => document.getElementById('setting-chat-avatar-input').click());
            document.getElementById('setting-chat-avatar-input').addEventListener('change', (e) => {
                handleAvatarUpload(e, (base64) => { ELS.chatAvatar.src = base64; updateConfig('chatAvatar', base64); });
            });
            
            document.getElementById('setting-chat-bg-input').addEventListener('change', async (e) => { if (!e.target.files[0]) return; const base64 = await fileToBase64(e.target.files[0]); updateConfig('background', base64); });
            document.getElementById('remove-bg-btn').addEventListener('click', async () => { updateConfig('background', ''); });
            
            ELS.chatInput.addEventListener('input', updateSendButtonState);
            ELS.sendBtn.addEventListener('click', sendUserMessage);
            
            document.getElementById('plus-btn').addEventListener('click', togglePlusMenu);
            document.getElementById('add-transaction-btn').addEventListener('click', () => { hidePlusMenu(); showTransactionPanel(); });
            document.getElementById('add-schedule-btn').addEventListener('click', () => { hidePlusMenu(); showSchedulePanel(); });
            
            document.getElementById('ai-trigger-btn').addEventListener('click', showAICharacterSelector);
            document.getElementById('image-upload-btn').addEventListener('click', () => document.getElementById('image-upload-input').click());
            document.getElementById('image-upload-input').addEventListener('change', sendUserImage);
            document.getElementById('close-transaction-panel').addEventListener('click', hideTransactionPanel);
            document.getElementById('close-schedule-panel').addEventListener('click', hideSchedulePanel);
            document.getElementById('type-expense-btn').addEventListener('click', () => switchTransactionType('expense'));
            document.getElementById('type-income-btn').addEventListener('click', () => switchTransactionType('income'));
            document.querySelector('.numpad').addEventListener('click', handleNumpad);
            document.getElementById('numpad-delete').addEventListener('click', handleNumpadDelete);
            document.getElementById('numpad-confirm').addEventListener('click', confirmTransaction);
            document.getElementById('currency-selector').addEventListener('click', toggleCurrency);
            
            setupSchedulePanelListeners();
            setupCalendarModalListeners();
            
            // Ledger page listeners
            document.getElementById('ledger-month-filter-btn').addEventListener('click', openMonthFilterModal);
            document.getElementById('ledger-category-filter-btn').addEventListener('click', openCategoryFilterModal);
            ELS.ledgerSort.addEventListener('change', renderLedger);
            ELS.ledgerCurrency.addEventListener('change', renderLedger);
            document.getElementById('forward-ledger-btn').addEventListener('click', forwardLedgerToChat);
            document.getElementById('forward-schedule-btn').addEventListener('click', forwardScheduleToChat);

            setupModal('manage-proxies-btn', 'api-proxy-modal', 'close-proxy-modal', renderProxyList);
            setupModal('manage-characters-btn', 'ai-character-modal', 'close-character-modal', renderCharacterList);
            setupModal('manage-currencies-btn', 'currency-list-modal', 'close-currency-list-modal', renderCurrencyList);
            setupModal('manage-system-prompts-btn', 'system-prompts-modal', null, openSystemPromptsEditor);
            document.getElementById('add-proxy-btn').addEventListener('click', () => openProxyEditor());
            document.getElementById('add-character-btn').addEventListener('click', () => openCharacterEditor());
            document.getElementById('add-currency-btn').addEventListener('click', () => openCurrencyEditor());
            setupEditorModal('proxy-editor-modal', saveProxy);
            setupEditorModal('character-editor-modal', saveCharacter);
            setupEditorModal('currency-editor-modal', saveCurrency);
            setupEditorModal('system-prompts-modal', saveSystemPrompts);
            setupEditorModal('ledger-month-filter-modal', () => { applyLedgerFilters(); document.getElementById('ledger-month-filter-modal').classList.remove('visible'); });
            setupEditorModal('ledger-category-filter-modal', () => { applyLedgerFilters(); document.getElementById('ledger-category-filter-modal').classList.remove('visible'); });
            setupEditorModal('cropper-modal', null); 
            setupModal(null, 'ai-character-selector-modal', null, null);
            setupModal(null, 'message-action-menu', null);
            
            const scheduleDetailModal = document.getElementById('schedule-detail-modal');
            scheduleDetailModal.querySelector('#close-schedule-detail-modal').addEventListener('click', () => scheduleDetailModal.classList.remove('visible'));
            scheduleDetailModal.querySelector('#edit-schedule-btn').addEventListener('click', handleEditScheduleFromModal);
            scheduleDetailModal.querySelector('#delete-schedule-btn').addEventListener('click', handleDeleteScheduleFromModal);

            document.getElementById('export-json-btn').addEventListener('click', exportAsJSON);
            document.getElementById('import-json-btn').addEventListener('click', () => document.getElementById('import-json-input').click());
            document.getElementById('import-json-input').addEventListener('change', importFromJSON);
            document.getElementById('export-txt-btn').addEventListener('click', exportAsTXT);
            
            ELS.chatSettingsBtn.addEventListener('click', toggleSidebar);
            ELS.sidebarOverlay.addEventListener('click', toggleSidebar);
            ELS.previewContextBtn.addEventListener('click', toggleContextPreview);
            
            document.getElementById('cancel-selection-btn').addEventListener('click', exitSelectionMode);
            document.getElementById('delete-selected-btn').addEventListener('click', deleteSelectedMessages);
            
            document.addEventListener('click', (e) => { if (!e.target.closest('#plus-btn') && !e.target.closest('#plus-menu')) { hidePlusMenu(); } });
            
            // Ledger view toggle and swipe
            const ledgerContent = document.getElementById('ledger-page-content');
            const ledgerWrapper = document.getElementById('ledger-view-wrapper');
            let touchStartX = 0;
            let isChartView = false;

            ledgerContent.addEventListener('touchstart', e => {
                touchStartX = e.changedTouches[0].screenX;
            }, { passive: true });

            ledgerContent.addEventListener('touchend', e => {
                const touchEndX = e.changedTouches[0].screenX;
                const swipeDist = touchEndX - touchStartX;
                if (Math.abs(swipeDist) < 50) return;

                if (swipeDist < 0 && !isChartView) { // Swipe left
                    ledgerWrapper.style.transform = 'translateX(-100%)';
                    isChartView = true;
                    document.getElementById('toggle-ledger-view-btn').textContent = 'üìÑ';
                } else if (swipeDist > 0 && isChartView) { // Swipe right
                    ledgerWrapper.style.transform = 'translateX(0%)';
                    isChartView = false;
                    document.getElementById('toggle-ledger-view-btn').textContent = 'üìä';
                }
            });

            document.getElementById('toggle-ledger-view-btn').addEventListener('click', () => {
                isChartView = !isChartView;
                if (isChartView) {
                    ledgerWrapper.style.transform = 'translateX(-100%)';
                    document.getElementById('toggle-ledger-view-btn').textContent = 'üìÑ';
                } else {
                    ledgerWrapper.style.transform = 'translateX(0%)';
                    document.getElementById('toggle-ledger-view-btn').textContent = 'üìä';
                }
            });
            
            // Ledger list item click for editing
            ELS.ledgerList.addEventListener('click', (e) => {
                const item = e.target.closest('.ledger-item');
                if (item && item.dataset.id) {
                    showTransactionPanel(parseInt(item.dataset.id));
                }
            });
        }
        
        function togglePlusMenu() { ELS.plusMenu.classList.toggle('visible'); }
        function hidePlusMenu() { ELS.plusMenu.classList.remove('visible'); }
        
        function updateSendButtonState() { const hasText = ELS.chatInput.value.trim().length > 0; ELS.sendBtn.disabled = !hasText; }

        async function sendUserMessage() {
            if (ELS.sendBtn.disabled) return;
            const text = ELS.chatInput.value.trim();
            
            if (text) {
                const newMsg = { timestamp: Date.now(), role: 'user', content: text, type: 'text' };
                const id = await db.messages.add(newMsg);
                state.messages.push({ ...newMsg, id }); 
                ELS.chatInput.value = '';
                renderChatMessages();
                updateSendButtonState();
            }
        }

        async function sendUserImage(event) {
            const file = event.target.files[0];
            if (!file) return;
            const base64 = await fileToBase64(file);
            const newMsg = { timestamp: Date.now(), role: 'user', content: base64, type: 'image' };
            const id = await db.messages.add(newMsg);
            state.messages.push({ ...newMsg, id });
            renderChatMessages();
            event.target.value = ''; 
        }

        async function triggerAIResponse(character) {
            const proxy = state.proxies.find(p => p.id === character.proxyId);
            const backupProxy = state.proxies.find(p => p.id === character.backupProxyId);
            if (!proxy || !character.model) {
                alert(`ËßíËâ≤ "${character.name}" Êú™ÈÖçÁΩÆ‰∏ªÁî®APIÊàñÊ®°ÂûãÔºåÊó†Ê≥ïÂèëË®Ä„ÄÇ`);
                return;
            }

            const now = new Date();
            const formattedDateTime = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')} ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            
            let userProfileString = '';
            if (state.config.userId || state.config.userGender || state.config.userBio) {
                userProfileString += "[User Profile]\n";
                if (state.config.userId) userProfileString += `- ID: ${state.config.userId}\n`;
                if (state.config.userGender) userProfileString += `- Gender: ${state.config.userGender}\n`;
                if (state.config.userBio) userProfileString += `- Bio: ${state.config.userBio}\n`;
                userProfileString += '\n';
            }

            const { sendTime, sendModel, sendRole } = state.config.systemPromptSettings;
            let systemInfo = "[System Info]\n";
            if (sendModel) systemInfo += `- Current Model: ${character.model}\n`;
            if (sendTime) systemInfo += `- Current Time: ${formattedDateTime}\n`;
            if (sendRole) systemInfo += `- Your Role: ${character.name}\n`;
            systemInfo += `\n---\n\n`;
            
            const systemPrefix = userProfileString + systemInfo;
            const systemPrompt = systemPrefix + `${character.prompt}\n\n‰Ω†ÁöÑ‰ªªÂä°ÊòØ‰Ωú‰∏∫ËÅäÂ§©‰ºô‰º¥ÂØπÁî®Êà∑ÁöÑËÆ∞Ë¥¶ÂíåËÅäÂ§©ÂÜÖÂÆπÂÅöÂá∫ÂõûÂ∫î„ÄÇ‰Ω†ÁöÑÂõûÂ∫îÈúÄË¶ÅÁ¨¶Âêà‰Ω†ÁöÑ‰∫∫ËÆæ„ÄÇÂ¶ÇÊûúÁî®Êà∑Âèë‰∫ÜÂõæÁâáÔºå‰Ω†Ë¶ÅÂÉèËÉΩÁúãÂà∞‰∏ÄÊ†∑ËøõË°åËØÑËÆ∫„ÄÇËØ∑Ëá™ÁÑ∂Âú∞ËøõË°åÂØπËØù„ÄÇ‰Ω†ÂèØ‰ª•‰∏ÄÊ¨°ÊÄßÂèëÈÄÅÂ§öÊù°Ê∂àÊÅØÔºåÁî®Êç¢Ë°åÔºà\\nÔºâÂàÜÈöî„ÄÇ‰æãÂ¶Ç: "‰Ω†Â•ΩÂëÄ\\n‰ªäÂ§©ËøáÂæóÊÄé‰πàÊ†∑Ôºü"„ÄÇ`;
            const history = buildContext(state.config.maxTokens || 4096).context;
            const thinkingBubbleId = addThinkingBubble(character);
            
            let responseText;
            try {
                responseText = await callAPI(proxy, systemPrompt, history, character.model);
                await processAIResponse(responseText, thinkingBubbleId, character);
            } catch (mainError) {
                console.error("Main API failed:", mainError);
                if (backupProxy && character.backupModel) {
                    console.log("Main API failed, trying backup API...");
                    
                    const thinkingBubble = document.getElementById(thinkingBubbleId);
                    if (thinkingBubble) {
                        const contentEl = thinkingBubble.querySelector('.content-text');
                        if (contentEl) contentEl.innerHTML = '‰∏ªÁî®APIÊä•ÈîôÔºåÊ≠£Âú®Â∞ùËØïÂ§áÁî®API...';
                    }
                    
                    try {
                        await new Promise(resolve => setTimeout(resolve, 1000)); 
                        let backupSystemInfo = "[System Info]\n";
                        if (sendModel) backupSystemInfo += `- Current Model: ${character.backupModel}\n`;
                        if (sendTime) backupSystemInfo += `- Current Time: ${formattedDateTime}\n`;
                        if (sendRole) backupSystemInfo += `- Your Role: ${character.name}\n`;
                        backupSystemInfo += `\n---\n\n`;
                        const backupSystemPrefix = userProfileString + backupSystemInfo;
                        const backupSystemPrompt = backupSystemPrefix + `${character.prompt}\n\n‰Ω†ÁöÑ‰ªªÂä°ÊòØ‰Ωú‰∏∫ËÅäÂ§©‰ºô‰º¥ÂØπÁî®Êà∑ÁöÑËÆ∞Ë¥¶ÂíåËÅäÂ§©ÂÜÖÂÆπÂÅöÂá∫ÂõûÂ∫î„ÄÇ‰Ω†ÁöÑÂõûÂ∫îÈúÄË¶ÅÁ¨¶Âêà‰Ω†ÁöÑ‰∫∫ËÆæ„ÄÇÂ¶ÇÊûúÁî®Êà∑Âèë‰∫ÜÂõæÁâáÔºå‰Ω†Ë¶ÅÂÉèËÉΩÁúãÂà∞‰∏ÄÊ†∑ËøõË°åËØÑËÆ∫„ÄÇËØ∑Ëá™ÁÑ∂Âú∞ËøõË°åÂØπËØù„ÄÇ‰Ω†ÂèØ‰ª•‰∏ÄÊ¨°ÊÄßÂèëÈÄÅÂ§öÊù°Ê∂àÊÅØÔºåÁî®Êç¢Ë°åÔºà\\nÔºâÂàÜÈöî„ÄÇ‰æãÂ¶Ç: "‰Ω†Â•ΩÂëÄ\\n‰ªäÂ§©ËøáÂæóÊÄé‰πàÊ†∑Ôºü"„ÄÇ`;
                        responseText = await callAPI(backupProxy, backupSystemPrompt, history, character.backupModel);
                        await processAIResponse(responseText, thinkingBubbleId, character);
                    } catch (backupError) {
                        console.error("Backup API also failed:", backupError);
                        await updateThinkingBubble(thinkingBubbleId, `[Â§áÁî®APIËøûÊé•Â§±Ë¥•: ${backupError.message}]`, character.id, true);
                    }
                } else {
                    await updateThinkingBubble(thinkingBubbleId, `[ËøûÊé•Â§±Ë¥•: ${mainError.message}]`, character.id, true);
                }
            }
        }
        
        async function processAIResponse(text, bubbleId, character) {
            const aiReplies = text.split('\n').map(r => r.trim()).filter(Boolean);
            if (aiReplies.length > 0) {
                await updateThinkingBubble(bubbleId, aiReplies[0], character.id);
                for (let i = 1; i < aiReplies.length; i++) {
                    await new Promise(resolve => setTimeout(resolve, Math.random() * 600 + 200));
                    await addAIMessage(aiReplies[i], character.id);
                }
            } else { await updateThinkingBubble(bubbleId, "[AIÊ≤°ÊúâËøîÂõû‰ªª‰ΩïÂÜÖÂÆπ]", character.id, true); }
        }
        
        function buildContext(maxTokens) {
            let context = []; let currentTokens = 0; const reversedMessages = [...state.messages].reverse();
            const { systemPromptSettings } = state.config;

            for (const msg of reversedMessages) {
                let content; let msgTokens = 0;
                const role = msg.role === 'assistant' ? 'assistant' : 'user';

                if (msg.type === 'transaction') {
                    const t = state.transactions.find(t => t.id === msg.relatedId);
                    if(!t) continue;
                    content = `[ËÆ∞Ë¥¶ÊèêÈÜí] Êàë${t.type === 'expense' ? 'Ëä±‰∫Ü' : 'Ëµö‰∫Ü'} ${t.amount}${t.currency}ÔºåÂàÜÁ±ªÊòØ${CATEGORIES[t.type].find(c=>c.id===t.category)?.name || 'Êú™Áü•'}ÔºåÂ§áÊ≥®ÊòØÔºö‚Äú${t.remark}‚Äù`;
                    msgTokens = content.length * 2;
                } else if (msg.type === 'schedule') {
                    const s = state.schedules.find(s => s.id === msg.relatedId);
                    if(!s) continue;
                    const deadlineStr = s.deadline ? formatDeadline(s.deadline) : 'Êó†';
                    const descriptionText = s.description ? `ËØ¥ÊòéÊòØ‚Äú${s.description}‚Äù` : "Êó†";
                    const statusText = s.completed ? 'Â∑≤ÂÆåÊàê' : 'Êú™ÂÆåÊàê';
                    content = `[Êó•Á®ãÊèêÈÜí] ÊàëÂÆö‰∫Ü‰∏™‰∫ãÔºö'${s.title}'„ÄÇÈáçË¶ÅÁ®ãÂ∫¶ÊòØ ${s.importance.toFixed(1)}/10ÔºåÊà™Ê≠¢Êó•ÊúüÊòØ ${deadlineStr}Ôºå${descriptionText}ÔºåÂΩìÂâçÁä∂ÊÄÅÔºö${statusText}„ÄÇ`;
                    msgTokens = content.length * 2;
                } else if (msg.type === 'image') {
                    content = [{ type: "image_url", image_url: { url: msg.content } }];
                    msgTokens = 1000; 
                } else if (msg.type === 'ledger_summary') {
                    const data = JSON.stringify(getFilteredTransactions().filtered);
                    content = (systemPromptSettings.ledger || DEFAULT_SYSTEM_PROMPTS.ledger).replace('{data}', data);
                    msgTokens = content.length * 2;
                } else if (msg.type === 'schedule_summary') {
                    const data = JSON.stringify(state.schedules);
                    content = (systemPromptSettings.schedule || DEFAULT_SYSTEM_PROMPTS.schedule).replace('{data}', data);
                    msgTokens = content.length * 2;
                } else if (msg.type === 'pie_chart_summary') {
                    content = (systemPromptSettings.pie || DEFAULT_SYSTEM_PROMPTS.pie).replace('{data}', msg.content);
                    msgTokens = content.length * 2;
                } else {
                    content = msg.content;
                    msgTokens = content.length * 2;
                }
                
                if (currentTokens + msgTokens <= maxTokens) {
                    const finalRole = (msg.type !== 'text' && msg.role === 'user') ? 'user' : role;
                    const messageForContext = { role: finalRole, content };
                    
                    if (finalRole === 'assistant' && msg.senderId) {
                        const character = state.characters.find(c => c.id === msg.senderId);
                        if (character) {
                            messageForContext.character_name = character.name;
                        }
                    }
                    
                    context.unshift(messageForContext);
                    currentTokens += msgTokens;
                } else {
                    break;
                }
            }
            return { context, tokens: currentTokens };
        }

        async function callAPI(proxy, systemPrompt, history, model) {
            const res = await fetch(`${proxy.url}/v1/chat/completions`, { 
                method: 'POST', 
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${proxy.apiKey}` }, 
                body: JSON.stringify({ 
                    model: model, 
                    messages: [{ role: 'system', content: systemPrompt }, ...history], 
                    temperature: 0.8 
                }) 
            });
            if (!res.ok) { 
                const errorText = await res.text();
                let errorMessage = 'Êú™Áü•APIÈîôËØØ';
                try {
                    const errorJson = JSON.parse(errorText);
                    errorMessage = errorJson.error.message || errorText;
                } catch(e) {
                    errorMessage = errorText;
                }
                throw new Error(errorMessage);
            }
            const data = await res.json();
            return data.choices[0].message.content;
        }

        async function addAIMessage(content, senderId = null) {
            const newMsg = { timestamp: Date.now(), role: 'assistant', content, type: 'text', senderId };
            const id = await db.messages.add(newMsg);
            state.messages.push({ ...newMsg, id });
            renderChatMessages();
        }

        function addThinkingBubble(character) {
            const bubbleId = `thinking-${Date.now()}`;
            const wrapper = createMessageElement({ id: bubbleId, role: 'assistant', type: 'text', senderId: character.id, content: `<div class="typing-indicator"><span>.</span><span>.</span><span>.</span></div>` });
            ELS.chatMessages.appendChild(wrapper); ELS.chatMessages.scrollTop = ELS.chatMessages.scrollHeight;
            return bubbleId;
        }

        async function updateThinkingBubble(bubbleId, content, senderId, isError = false) {
            const newMsgData = { timestamp: Date.now(), role: 'assistant', content, type: 'text', senderId };
            const newId = await db.messages.add(newMsgData);
            state.messages.push({ ...newMsgData, id: newId });
            const bubbleWrapper = document.getElementById(bubbleId);
            if (bubbleWrapper) { const newBubble = createMessageElement({ ...newMsgData, id: newId }, isError); bubbleWrapper.parentElement.replaceChild(newBubble, bubbleWrapper); }
            state.messages = state.messages.filter(m => m.id !== bubbleId);
        }

        function parseSimpleMarkdown(text) {
            if (!text) return '';
            let escapedText = text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
            escapedText = escapedText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            escapedText = escapedText.replace(/\*(.*?)\*/g, '<em>$1</em>');
            escapedText = escapedText.replace(/\n/g, '<br>');
            return escapedText;
        }

        function createMessageElement(msg, isError = false) {
            const wrapper = document.createElement('div');
            wrapper.className = `message-wrapper ${msg.role === 'user' ? 'user' : 'ai'}`;
            if (isError) wrapper.classList.add('error');
            wrapper.id = msg.id;
            wrapper.dataset.id = msg.id;

            const checkbox = document.createElement('div');
            checkbox.className = 'message-selection-checkbox';
            checkbox.innerHTML = '‚úì';
            wrapper.appendChild(checkbox);

            wrapper.addEventListener('click', (e) => {
                if (state.isSelectionMode) {
                    e.stopPropagation();
                    toggleMessageSelection(msg.id);
                }
            });
            
            let character = msg.senderId ? state.characters.find(c => c.id === msg.senderId) : null;

            const avatar = document.createElement('img');
            avatar.className = 'avatar';
            avatar.src = msg.role === 'user' ? (state.config.chatAvatar || DEFAULT_AVATAR) : (character ? character.avatar : DEFAULT_AVATAR);
            
            const messageBlock = document.createElement('div');
            messageBlock.className = 'message-block';

            if (msg.role === 'assistant' && character) {
                const senderName = document.createElement('div');
                senderName.className = 'sender-name';
                senderName.textContent = character.name;
                messageBlock.appendChild(senderName);
            }
            
            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';
            bubble.classList.add(msg.type);

            const contentContainer = document.createElement('div');
            contentContainer.className = 'content';
            
            if (msg.type === 'transaction') {
                const t = state.transactions.find(t => t.id === msg.relatedId);
                if (!t) return wrapper;
                const category = CATEGORIES[t.type].find(c => c.id === t.category);
                const remarkText = t.remark || 'Ê≤°ÊúâÂ§áÊ≥®Âì¶~';
                contentContainer.innerHTML = `<div class="transaction-card"><div class="transaction-header ${t.type}"><div class="icon">${category?.icon||'ü§î'}</div><div class="category-name">${category?.name||'Êú™Áü•ÂàÜÁ±ª'}</div></div><div class="transaction-body"><div class="transaction-amount">${t.type==='expense'?'-':'+'}${t.amount.toFixed(2)}<span class="currency-label">${t.currency}</span></div><div class="transaction-remark"><span class="original-text">${remarkText}</span></div></div></div>`;
            } else if (msg.type === 'schedule') {
                const s = state.schedules.find(s => s.id === msg.relatedId);
                if (!s) return wrapper;
                const deadlineStr = s.deadline ? formatDeadline(s.deadline) : 'Êó†';
                const statusClass = s.completed ? 'completed' : 'pending';
                const statusText = s.completed ? 'Â∑≤ÂÆåÊàê' : 'Êú™ÂÆåÊàê';
                contentContainer.innerHTML = `<div class="schedule-card"><div class="schedule-header"><div class="icon">üè∑Ô∏è</div><div class="type-name">${s.eventType==='long'?'ÈïøÊúü‰∫ã‰ª∂':'ÂçïÊ¨°‰∫ã‰ª∂'}</div></div><div class="schedule-body"><div class="schedule-title">${s.title}</div><div class="schedule-importance">ÈáçË¶ÅÁ®ãÂ∫¶: ${s.importance.toFixed(1)}</div><div class="schedule-deadline">Êà™Ê≠¢: ${deadlineStr}</div><div class="schedule-status ${statusClass}">Áä∂ÊÄÅ: ${statusText}</div>${s.description?`<div class="schedule-description"><span class="original-text">${s.description}</span></div>`:''}</div></div>`;
            } else if (msg.type === 'image') {
                contentContainer.innerHTML = `<img src="${msg.content}" class="chat-image" alt="Áî®Êà∑ÂèëÈÄÅÁöÑÂõæÁâá">`;
            } else if (msg.type === 'ledger_summary') {
                contentContainer.innerHTML = `<div class="summary-card"><div class="summary-header"><div class="icon">üìñ</div><div class="type-name">ÊàëÁöÑË¥¶Êú¨</div></div><div class="summary-body"><div class="text">Â∑≤Â∞ÜÁ≠õÈÄâË¥¶Êú¨‰ø°ÊÅØÂêåÊ≠•ÁªôAI</div></div></div>`;
            } else if (msg.type === 'schedule_summary') {
                contentContainer.innerHTML = `<div class="summary-card"><div class="summary-header"><div class="icon">üóìÔ∏è</div><div class="type-name">ÊàëÁöÑÊó•Á®ã</div></div><div class="summary-body"><div class="text">Â∑≤Â∞ÜÊúÄÊñ∞Êó•Á®ã‰ø°ÊÅØÂêåÊ≠•ÁªôAI</div></div></div>`;
            } else if (msg.type === 'pie_chart_summary') {
                contentContainer.innerHTML = `<div class="summary-card"><div class="summary-header"><div class="icon">üìä</div><div class="type-name">Ë¥¶Êú¨ÂõæË°®</div></div><div class="summary-body"><div class="text">Â∑≤Â∞ÜÂõæË°®ÂàÜÊûêÂêåÊ≠•ÁªôAI</div></div></div>`;
            } else { 
                const contentSpan = document.createElement('span');
                contentSpan.className = 'content-text';
                contentSpan.innerHTML = msg.id.toString().startsWith('thinking-') ? msg.content : parseSimpleMarkdown(msg.content);
                contentContainer.appendChild(contentSpan);
            }
            
            const metaContainer = document.createElement('div');
            metaContainer.className = 'message-meta';
            const timestamp = document.createElement('span');
            timestamp.className = 'timestamp';
            timestamp.textContent = msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';
            const menuTrigger = document.createElement('span');
            menuTrigger.className = 'message-actions-trigger';
            menuTrigger.innerHTML = '‚ãÆ';
            menuTrigger.addEventListener('click', (e) => { e.stopPropagation(); cancelCurrentEdit(); showActionMenu(msg.id); });
            metaContainer.append(timestamp, menuTrigger);

            bubble.append(contentContainer, metaContainer);
            messageBlock.appendChild(bubble);

            if (msg.role === 'user') {
                wrapper.append(messageBlock, avatar);
            } else {
                wrapper.append(avatar, messageBlock);
            }
            
            return wrapper;
        }

        function renderChatMessages(shouldScrollToBottom = true) {
            const lastScrollTop = ELS.chatMessages.scrollTop;
            const lastScrollHeight = ELS.chatMessages.scrollHeight;
            const isScrolledToBottom = lastScrollHeight - lastScrollTop - ELS.chatMessages.clientHeight < 1;

            ELS.chatMessages.innerHTML = '';
            state.messages.forEach(msg => {
                if (!msg.id.toString().startsWith('thinking-')) {
                    ELS.chatMessages.appendChild(createMessageElement(msg));
                }
            });

            if (shouldScrollToBottom || isScrolledToBottom) {
                ELS.chatMessages.scrollTop = ELS.chatMessages.scrollHeight;
            } else {
                ELS.chatMessages.scrollTop = lastScrollTop;
            }
        }
        
        function getFilteredTransactions() {
            const { months, categories, type } = state.ledgerFilters;
            const sort = ELS.ledgerSort.value;
            const displayCurrency = ELS.ledgerCurrency.value;
            
            const allCurrencies = [{code: 'RMB', rate: 1}, ...state.currencies];
            const toRate = allCurrencies.find(c => c.code === displayCurrency)?.rate || 1;

            let transactionsWithDisplayAmount = state.transactions.map(t => {
                const fromRate = allCurrencies.find(c => c.code === t.currency)?.rate || 1;
                const amountInRMB = t.amount * fromRate;
                const displayAmount = amountInRMB / toRate;
                return { ...t, displayAmount };
            });

            let filtered = transactionsWithDisplayAmount;

            // Filter by month
            if (months.length > 0) {
                filtered = filtered.filter(t => {
                    const date = new Date(t.timestamp);
                    const monthStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    return months.includes(monthStr);
                });
            }

            // Filter by category
            if (categories.length > 0) {
                filtered = filtered.filter(t => t.type === type && categories.includes(t.category));
            }
            
            filtered.sort((a, b) => { 
                switch(sort) { 
                    case 'time_asc': return a.timestamp - b.timestamp; 
                    case 'amount_desc': return b.displayAmount - a.displayAmount; 
                    case 'amount_asc': return a.displayAmount - b.displayAmount; 
                    default: return b.timestamp - a.timestamp; 
                } 
            });

            return { filtered, displayCurrency };
        }

        function renderLedger() {
            const { filtered, displayCurrency } = getFilteredTransactions();
            
            // Render List
            ELS.ledgerList.innerHTML = ''; 
            let totalExpense = 0, totalIncome = 0; 
            
            if (filtered.length === 0) { 
                ELS.ledgerList.innerHTML = '<li class="empty-state">Ê≤°ÊúâÁ¨¶ÂêàÁ≠õÈÄâÊù°‰ª∂ÁöÑËÆ∞ÂΩï</li>'; 
            } else { 
                filtered.forEach(t => { 
                    if (t.type === 'expense') totalExpense += t.displayAmount; 
                    else totalIncome += t.displayAmount; 
                    
                    const category = CATEGORIES[t.type].find(c => c.id === t.category); 
                    const li = document.createElement('li'); 
                    li.className = 'ledger-item'; 
                    li.dataset.id = t.id;
                    li.innerHTML = `<div class="icon">${category?.icon || 'ü§î'}</div><div class="details"><div class="remark">${t.remark || category?.name || '‰∏ÄÁ¨îË¥¶'}</div><div class="time">${new Date(t.timestamp).toLocaleString()}</div></div><div class="amount ${t.type}">${t.type === 'expense' ? '-' : '+'}${t.displayAmount.toFixed(2)}</div>`; 
                    ELS.ledgerList.appendChild(li); 
                }); 
            } 
            ELS.ledgerSummary.innerHTML = `ÊÄªÊîØÂá∫ (${displayCurrency}): <span style="color:var(--expense-color)">${totalExpense.toFixed(2)}</span> | ÊÄªÊî∂ÂÖ• (${displayCurrency}): <span style="color:var(--income-color)">${totalIncome.toFixed(2)}</span>`;

            // Render Charts
            renderPieCharts(filtered, displayCurrency);
        }

        function generatePieChartSubtitle() {
            const { months, categories, type } = state.ledgerFilters;

            let timeText;
            if (months.length === 0) {
                timeText = 'ÂÖ®Êó∂Èó¥';
            } else {
                const sorted = months.map(m => new Date(m + '-01')).sort((a,b) => a - b);
                const isContinuous = sorted.every((date, i) => {
                    if (i === 0) return true;
                    const prev = sorted[i-1];
                    return prev.getFullYear() === date.getFullYear() && prev.getMonth() + 1 === date.getMonth();
                });

                if (isContinuous && sorted.length > 1) {
                    const start = sorted[0];
                    const end = sorted[sorted.length - 1];
                    timeText = `${start.getFullYear()}Âπ¥${start.getMonth()+1}Êúà - ${end.getFullYear()}Âπ¥${end.getMonth()+1}Êúà`;
                } else {
                    timeText = sorted.map(d => `${d.getFullYear()}Âπ¥${d.getMonth()+1}Êúà`).join('„ÄÅ');
                }
            }

            let categoryText;
            const allCategoriesForType = CATEGORIES[type].map(c => c.id);
            if (categories.length === 0 || categories.length === allCategoriesForType.length) {
                categoryText = 'ÊÄªÂÖ±';
            } else {
                categoryText = categories.map(catId => {
                    const cat = CATEGORIES[type].find(c => c.id === catId);
                    return cat ? cat.name : '';
                }).filter(Boolean).join('„ÄÅ');
            }

            return `${timeText} ${categoryText}`;
        }

        function renderPieCharts(transactions, currency) {
            const subtitleText = generatePieChartSubtitle();
            document.getElementById('expense-pie-subtitle').textContent = subtitleText;
            document.getElementById('income-pie-subtitle').textContent = subtitleText;

            const expenseData = {};
            const incomeData = {};

            transactions.forEach(t => {
                const data = t.type === 'expense' ? expenseData : incomeData;
                if (!data[t.category]) {
                    data[t.category] = 0;
                }
                data[t.category] += t.displayAmount;
            });

            drawPieChart('expense-pie-chart', 'expense-pie-legend', expenseData, CATEGORIES.expense, currency);
            drawPieChart('income-pie-chart', 'income-pie-legend', incomeData, CATEGORIES.income, currency);
        }

        function polarToCartesian(centerX, centerY, radius, angleInDegrees) {
            const angleInRadians = (angleInDegrees - 90) * Math.PI / 180.0;
            return {
                x: centerX + (radius * Math.cos(angleInRadians)),
                y: centerY + (radius * Math.sin(angleInRadians))
            };
        }

        function describeArc(x, y, radius, startAngle, endAngle) {
            const start = polarToCartesian(x, y, radius, endAngle);
            const end = polarToCartesian(x, y, radius, startAngle);
            const largeArcFlag = endAngle - startAngle <= 180 ? "0" : "1";
            const d = [ "M", start.x, start.y, "A", radius, radius, 0, largeArcFlag, 0, end.x, end.y, "L", x, y, "L", start.x, start.y ].join(" ");
            return d;
        }

        function drawPieChart(svgId, legendId, data, categoryDefinitions, currency) {
            const svg = document.getElementById(svgId);
            const legend = document.getElementById(legendId);
            svg.innerHTML = '';
            legend.innerHTML = '';
            svg.setAttribute('viewBox', '0 0 250 250');
            const tooltip = document.getElementById('pie-chart-tooltip');
            const totalAmount = Object.values(data).reduce((sum, amount) => sum + amount, 0);

            if (totalAmount === 0) {
                const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
                text.setAttribute('x', '50%');
                text.setAttribute('y', '50%');
                text.setAttribute('text-anchor', 'middle');
                text.setAttribute('fill', getComputedStyle(document.body).getPropertyValue('--text-secondary'));
                text.textContent = 'Êó†Êï∞ÊçÆ';
                svg.appendChild(text);
                return;
            }

            const cx = 125, cy = 125, radius = 110;
            const colors = ['#f28b82', '#ffc107', '#8dd4bf', '#87c4f4', '#c58af9', '#f4aab6', '#fbc5a6', '#a1c9f4', '#b2e2a4', '#d6a3d6'];
            let colorIndex = 0;
            let startAngle = 0;

            const sortedData = Object.entries(data).sort(([, a], [, b]) => b - a);

            for (const [categoryId, amount] of sortedData) {
                const percentage = (amount / totalAmount) * 100;
                const angle = percentage / 100 * 360;
                const endAngle = startAngle + angle;
                const categoryInfo = categoryDefinitions.find(c => c.id === categoryId);
                const categoryName = categoryInfo ? categoryInfo.name : 'Êú™Áü•';
                const color = colors[colorIndex++ % colors.length];

                const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                path.setAttribute("d", describeArc(cx, cy, radius, startAngle, endAngle));
                path.setAttribute("fill", color);
                path.dataset.name = categoryName;
                path.dataset.amount = amount.toFixed(2);
                path.dataset.percent = percentage.toFixed(1);

                path.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const currentActive = svg.querySelector('path.active');
                    if (currentActive && currentActive !== path) currentActive.classList.remove('active');
                    path.classList.toggle('active');

                    if (path.classList.contains('active')) {
                        tooltip.innerHTML = `<strong>${path.dataset.name}</strong><br>${path.dataset.percent}%<br>${path.dataset.amount} ${currency}`;
                        const chartViewRect = document.getElementById('ledger-chart-view').getBoundingClientRect();
                        const x = e.clientX - chartViewRect.left;
                        const y = e.clientY - chartViewRect.top + document.getElementById('ledger-chart-view').scrollTop;
                        tooltip.style.left = `${x}px`;
                        tooltip.style.top = `${y}px`;
                        tooltip.style.display = 'block';
                    } else {
                        tooltip.style.display = 'none';
                    }
                });
                svg.appendChild(path);
                
                const legendItem = document.createElement('div');
                legendItem.className = 'legend-item';
                legendItem.innerHTML = `<span class="legend-color-box" style="background-color: ${color};"></span><span>${categoryName}</span>`;
                legend.appendChild(legendItem);

                startAngle = endAngle;
            }
        }

        if (!document.getElementById('ledger-chart-view').dataset.listenerAttached) {
            document.getElementById('ledger-chart-view').addEventListener('click', (e) => {
                if (e.target.tagName !== 'path') {
                    document.getElementById('pie-chart-tooltip').style.display = 'none';
                    const currentActive = document.querySelector('#ledger-chart-view path.active');
                    if (currentActive) currentActive.classList.remove('active');
                }
            });
            document.getElementById('ledger-chart-view').dataset.listenerAttached = 'true';
        }

        function populateLedgerCurrencyFilter() {
            const select = ELS.ledgerCurrency;
            select.innerHTML = '';
            const allCurrenciesForFilter = [{code: 'RMB', name: '‰∫∫Ê∞ëÂ∏Å'}, ...state.currencies];
            allCurrenciesForFilter.forEach(c => {
                const option = document.createElement('option');
                option.value = c.code;
                option.textContent = `${c.name} (${c.code})`;
                select.appendChild(option);
            });
            select.value = 'RMB';
        }
        
        function showActionMenu(msgId) {
            const menu = document.getElementById('message-action-menu');
            const msg = state.messages.find(m => m.id === msgId);
            if (!msg) return;

            document.getElementById('multi-select-btn').onclick = () => { menu.classList.remove('visible'); enterSelectionMode(); };
            
            const editUserBtn = document.getElementById('edit-message-btn');
            const editAiBtn = document.getElementById('edit-ai-message-btn');
            const copyBtn = document.getElementById('copy-message-btn');
            const deleteBtn = document.getElementById('delete-message-btn');

            const isUserText = msg.role === 'user' && msg.type === 'text';
            const isUserTransaction = msg.role === 'user' && msg.type === 'transaction';
            const isUserSchedule = msg.role === 'user' && msg.type === 'schedule';
            const isAiText = msg.role === 'assistant' && msg.type === 'text';
            const isCopyable = isUserText || isAiText || (isUserTransaction && state.transactions.find(t => t.id === msg.relatedId)?.remark) || (isUserSchedule && state.schedules.find(s => s.id === msg.relatedId)?.description);

            editUserBtn.style.display = (isUserText || isUserTransaction || isUserSchedule) ? 'block' : 'none';
            if (isUserTransaction) editUserBtn.innerHTML = '‚úèÔ∏è ÁºñËæëÂ§áÊ≥®';
            else if (isUserSchedule) editUserBtn.innerHTML = '‚úèÔ∏è ÁºñËæëËØ¥Êòé';
            else editUserBtn.innerHTML = '‚úèÔ∏è ÁºñËæë';
            
            editAiBtn.style.display = isAiText ? 'block' : 'none';
            copyBtn.style.display = isCopyable ? 'block' : 'none';

            editUserBtn.onclick = () => { menu.classList.remove('visible'); editMessage(msgId); };
            editAiBtn.onclick = () => { menu.classList.remove('visible'); editMessage(msgId); };
            copyBtn.onclick = () => { menu.classList.remove('visible'); copyMessage(msgId); };
            deleteBtn.onclick = () => { menu.classList.remove('visible'); deleteMessage(msgId); };
            
            menu.classList.add('visible');
        }

        function cancelCurrentEdit() {
            if (!state.currentlyEditingMsgId) return;
            const msgElement = document.getElementById(state.currentlyEditingMsgId);
            if (msgElement) {
                const bubble = msgElement.querySelector('.message-bubble');
                if (bubble) bubble.classList.remove('editing');
                const editContainer = msgElement.querySelector('.inline-edit-container');
                if (editContainer) editContainer.remove();
            }
            state.currentlyEditingMsgId = null;
        }

        async function editMessage(msgId) {
            cancelCurrentEdit(); 
            state.currentlyEditingMsgId = msgId;

            const msgIndex = state.messages.findIndex(m => m.id === msgId);
            if (msgIndex === -1) return;
            const msg = state.messages[msgIndex];

            const msgElement = document.getElementById(msgId);
            if (!msgElement) return;

            const bubble = msgElement.querySelector('.message-bubble');
            let targetContainer, originalText;

            if (msg.type === 'transaction') {
                targetContainer = msgElement.querySelector('.transaction-remark');
                originalText = state.transactions.find(t => t.id === msg.relatedId)?.remark || '';
            } else if (msg.type === 'schedule') {
                targetContainer = msgElement.querySelector('.schedule-description');
                originalText = state.schedules.find(s => s.id === msg.relatedId)?.description || '';
            } else if (msg.type === 'text') {
                targetContainer = msgElement.querySelector('.content-text').parentElement;
                originalText = msg.content;
            } else {
                return; 
            }
            if (!targetContainer) { 
                alert("Ê≠§È°πÁõÆÊ≤°ÊúâÂèØÁºñËæëÁöÑÊñáÊú¨„ÄÇ");
                cancelCurrentEdit();
                return;
            }

            bubble.classList.add('editing');

            const editContainer = document.createElement('div');
            editContainer.className = 'inline-edit-container';
            
            const textarea = document.createElement('textarea');
            textarea.className = 'inline-edit-textarea';
            textarea.value = originalText.replace(/<br>/g, '\n');
            
            const autoResizeTextarea = () => {
                textarea.style.height = 'auto';
                textarea.style.height = `${textarea.scrollHeight}px`;
            };
            textarea.addEventListener('input', autoResizeTextarea);
            
            const actions = document.createElement('div');
            actions.className = 'inline-edit-actions';
            
            const saveBtn = document.createElement('button');
            saveBtn.innerHTML = '‚úì';
            saveBtn.className = 'save';
            
            const cancelBtn = document.createElement('button');
            cancelBtn.innerHTML = '√ó';
            cancelBtn.className = 'cancel';
            
            actions.append(saveBtn, cancelBtn);
            editContainer.append(textarea, actions);
            targetContainer.append(editContainer);

            autoResizeTextarea();
            textarea.focus();
            textarea.select();

            cancelBtn.onclick = (e) => { e.stopPropagation(); cancelCurrentEdit(); renderChatMessages(false); };

            saveBtn.onclick = async (e) => {
                e.stopPropagation();
                const newText = textarea.value.trim();
                
                if (msg.type === 'transaction') {
                    const trans = state.transactions.find(t => t.id === msg.relatedId);
                    if (trans) trans.remark = newText;
                    await db.transactions.update(msg.relatedId, { remark: newText });
                    if (document.getElementById('ledger-screen').classList.contains('active')) renderLedger();
                } else if (msg.type === 'schedule') {
                    const schedule = state.schedules.find(s => s.id === msg.relatedId);
                    if(schedule) schedule.description = newText;
                    await db.schedules.update(msg.relatedId, { description: newText });
                    if (document.getElementById('schedule-screen').classList.contains('active')) renderSchedules();
                } else if (msg.type === 'text') {
                    state.messages[msgIndex].content = newText;
                    await db.messages.update(msgId, { content: newText });
                }
                
                state.currentlyEditingMsgId = null; 
                renderChatMessages(false);
            };
        }

        async function deleteMessage(msgId) { 
            if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°Ê∂àÊÅØÂêóÔºü')) return; 
            const msg = state.messages.find(m => m.id === msgId); 
            if (!msg) return;
            if (msg.type === 'transaction' && msg.relatedId) { 
                await db.transactions.delete(msg.relatedId); 
                state.transactions = state.transactions.filter(t => t.id !== msg.relatedId); 
                renderLedger();
            } else if (msg.type === 'schedule' && msg.relatedId) {
                await db.schedules.delete(msg.relatedId);
                state.schedules = state.schedules.filter(s => s.id !== msg.relatedId);
                renderSchedules();
            }
            await db.messages.delete(msgId); 
            state.messages = state.messages.filter(m => m.id !== msgId); 
            renderChatMessages(false); 
        }
        async function copyMessage(msgId) {
            const msg = state.messages.find(m => m.id === msgId);
            if (!msg) return;

            let textToCopy = '';
            if (msg.type === 'text') {
                textToCopy = msg.content;
            } else if (msg.type === 'transaction') {
                textToCopy = state.transactions.find(t => t.id === msg.relatedId)?.remark || '';
            } else if (msg.type === 'schedule') {
                textToCopy = state.schedules.find(s => s.id === msg.relatedId)?.description || '';
            }

            if (textToCopy && navigator.clipboard) {
                try {
                    await navigator.clipboard.writeText(textToCopy);
                    alert('Â∑≤Â§çÂà∂ÔºÅ');
                } catch (err) {
                    console.error('Êó†Ê≥ïÂ§çÂà∂ÊñáÊú¨: ', err);
                    alert('Â§çÂà∂Â§±Ë¥•ÔºÅ');
                }
            }
        }

        function enterSelectionMode() { cancelCurrentEdit(); state.isSelectionMode = true; document.getElementById('accounting-screen').classList.add('selection-mode-active'); }
        function exitSelectionMode() { state.isSelectionMode = false; document.getElementById('accounting-screen').classList.remove('selection-mode-active'); state.selectedMessages.forEach(id => { document.querySelector(`.message-wrapper[data-id="${id}"]`)?.classList.remove('selected'); }); state.selectedMessages.clear(); }
        function toggleMessageSelection(msgId) { const wrapper = document.querySelector(`.message-wrapper[data-id="${msgId}"]`); if (state.selectedMessages.has(msgId)) { state.selectedMessages.delete(msgId); wrapper?.classList.remove('selected'); } else { state.selectedMessages.add(msgId); wrapper?.classList.add('selected'); } }
        async function deleteSelectedMessages() {
            const count = state.selectedMessages.size;
            if (count === 0) return;
            if (!confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§ÈÄâ‰∏≠ÁöÑ ${count} Êù°Ê∂àÊÅØÂêóÔºü`)) return;

            const msgIdsToDelete = Array.from(state.selectedMessages);
            const transIdsToDelete = [];
            const scheduleIdsToDelete = [];

            for (const msgId of msgIdsToDelete) {
                const msg = state.messages.find(m => m.id === msgId);
                if (msg) {
                    if (msg.type === 'transaction' && msg.relatedId) transIdsToDelete.push(msg.relatedId);
                    if (msg.type === 'schedule' && msg.relatedId) scheduleIdsToDelete.push(msg.relatedId);
                }
            }
            
            if (transIdsToDelete.length > 0) await db.transactions.bulkDelete(transIdsToDelete);
            if (scheduleIdsToDelete.length > 0) await db.schedules.bulkDelete(scheduleIdsToDelete);
            await db.messages.bulkDelete(msgIdsToDelete);
            
            state.transactions = state.transactions.filter(t => !transIdsToDelete.includes(t.id));
            state.schedules = state.schedules.filter(s => !scheduleIdsToDelete.includes(s.id));
            state.messages = state.messages.filter(m => !msgIdsToDelete.includes(m.id));

            exitSelectionMode();
            renderChatMessages(false);
            renderLedger();
            renderSchedules();
        }

        // --- Transaction Panel Logic ---
        function showTransactionPanel(id = null) {
            state.currentlyEditingTransactionId = id;
            const remarkInput = document.getElementById('transaction-remark-input');
            
            if (id) {
                const t = state.transactions.find(t => t.id === id);
                if (!t) { resetTransactionState(); return; }
                state.currentTransaction = {
                    type: t.type,
                    category: t.category,
                    amountStr: String(t.amount),
                    currency: t.currency
                };
                document.getElementById('transaction-panel-title').textContent = 'ÁºñËæëËÆ∞Ë¥¶';
                remarkInput.value = t.remark || ''; // Âä†ËΩΩÁé∞ÊúâÂ§áÊ≥®
            } else {
                resetTransactionState();
                document.getElementById('transaction-panel-title').textContent = 'Êñ∞Âª∫ËÆ∞Ë¥¶';
                remarkInput.value = ''; // Ê∏ÖÁ©∫Â§áÊ≥®
            }
            
            document.getElementById('currency-selector').textContent = state.currentTransaction.currency;
            updateAmountDisplay();
            switchTransactionType(state.currentTransaction.type, state.currentTransaction.category);
            
            ELS.transactionPanel.classList.add('visible');
            ELS.app.style.overflow = 'hidden';
        }

        function hideTransactionPanel() {
            ELS.transactionPanel.classList.remove('visible');
            ELS.app.style.overflow = 'initial';
            state.currentlyEditingTransactionId = null;
        }

        function switchTransactionType(type, preselectedCategory = null) {
            state.currentTransaction.type = type;
            document.getElementById('type-expense-btn').classList.toggle('active', type === 'expense');
            document.getElementById('type-income-btn').classList.toggle('active', type === 'income');
            renderCategories(preselectedCategory);
        }

        function renderCategories(preselectedCategory = null) {
            ELS.categorySelector.innerHTML = '';
            const cats = CATEGORIES[state.currentTransaction.type];
            cats.forEach(cat => {
                const item = document.createElement('div');
                item.className = 'category-item';
                item.dataset.id = cat.id;
                item.innerHTML = `<div class="icon">${cat.icon}</div><div class="name">${cat.name}</div>`;
                item.addEventListener('click', () => selectCategory(cat.id));
                ELS.categorySelector.appendChild(item);
            });
            if (preselectedCategory && cats.some(c => c.id === preselectedCategory)) {
                selectCategory(preselectedCategory);
            } else if (cats.length > 0) {
                selectCategory(cats[0].id);
            }
        }

        function selectCategory(catId) { state.currentTransaction.category = catId; document.querySelectorAll('.category-item').forEach(item => item.classList.toggle('selected', item.dataset.id === catId)); }
        function handleNumpad(e) { const key = e.target.dataset.key; if (!key) return; let amount = state.currentTransaction.amountStr; if (key === '.') { if (!amount.includes('.')) amount += '.'; } else { if (amount === '0') amount = key; else if (amount.includes('.') && amount.split('.')[1].length >= 2) return; else amount += key; } state.currentTransaction.amountStr = amount; updateAmountDisplay(); }
        function handleNumpadDelete() { let amount = state.currentTransaction.amountStr; amount = amount.slice(0, -1); if (amount === '') amount = '0'; state.currentTransaction.amountStr = amount; updateAmountDisplay(); }
        function toggleCurrency() { const currencies = ['RMB', ...state.currencies.map(c => c.code)]; const currentIndex = currencies.indexOf(state.currentTransaction.currency); const nextIndex = (currentIndex + 1) % currencies.length; const newCurrency = currencies[nextIndex]; state.currentTransaction.currency = newCurrency; document.getElementById('currency-selector').textContent = newCurrency; if (!state.currentlyEditingTransactionId) localStorage.setItem('lastSelectedCurrency', newCurrency); }
        function updateAmountDisplay() { ELS.amountDisplay.textContent = state.currentTransaction.amountStr; }
        
        async function confirmTransaction() {
            const amount = parseFloat(state.currentTransaction.amountStr);
            if (amount <= 0) { alert('ÈáëÈ¢ùÂøÖÈ°ªÂ§ß‰∫é0'); return; }
            
            const remark = document.getElementById('transaction-remark-input').value.trim(); // Ëé∑ÂèñÂ§áÊ≥®

            if (state.currentlyEditingTransactionId) {
                const transIndex = state.transactions.findIndex(t => t.id === state.currentlyEditingTransactionId);
                if (transIndex > -1) {
                    const originalTransaction = state.transactions[transIndex];
                    const updatedTransaction = {
                        ...originalTransaction,
                        type: state.currentTransaction.type,
                        category: state.currentTransaction.category,
                        amount: amount,
                        currency: state.currentTransaction.currency,
                        remark: remark // Êõ¥Êñ∞Â§áÊ≥®
                    };
                    await db.transactions.put(updatedTransaction);
                    state.transactions[transIndex] = updatedTransaction;
                    alert('ËÆ∞Ë¥¶Â∑≤Êõ¥Êñ∞ÔºÅ');
                    hideTransactionPanel();
                    renderLedger();
                    renderChatMessages(false);
                }
            } else {
                // ÂàõÂª∫Êñ∞ËÆ∞Ë¥¶Êó∂Áõ¥Êé•‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì
                const newTransaction = { 
                    timestamp: Date.now(), 
                    type: state.currentTransaction.type, 
                    category: state.currentTransaction.category, 
                    amount: amount, 
                    currency: state.currentTransaction.currency, 
                    remark: remark // ÂåÖÂê´Â§áÊ≥®
                };
                const transId = await db.transactions.add(newTransaction);
                const msgId = await db.messages.add({ 
                    timestamp: newTransaction.timestamp, 
                    role: 'user', 
                    content: ``, 
                    type: 'transaction', 
                    relatedId: transId 
                });
                state.transactions.push({ ...newTransaction, id: transId });
                state.messages.push({ id: msgId, timestamp: newTransaction.timestamp, role: 'user', type: 'transaction', relatedId: transId });
                
                hideTransactionPanel();
                resetTransactionState();
                renderChatMessages();
            }
        }

        function resetTransactionState() { 
            const lastCurrency = localStorage.getItem('lastSelectedCurrency') || 'RMB'; 
            state.currentTransaction = { type: 'expense', category: null, amountStr: '0', currency: lastCurrency }; 
            updateAmountDisplay(); 
            document.getElementById('currency-selector').textContent = lastCurrency;
            document.getElementById('transaction-remark-input').value = ''; // Ê∏ÖÁ©∫Â§áÊ≥®
        }
        
        // --- Schedule & Calendar Logic ---
        function setupSchedulePanelListeners() {
            document.getElementById('schedule-type-once').addEventListener('click', () => setScheduleType('once'));
            document.getElementById('schedule-type-long').addEventListener('click', () => setScheduleType('long'));
            setupImportanceStars();
            document.getElementById('confirm-schedule-btn').addEventListener('click', confirmSchedule);
            document.getElementById('cancel-schedule-btn').addEventListener('click', hideSchedulePanel);
            document.getElementById('deadline-display-text').addEventListener('click', showCalendarModal);
        }
        function setupCalendarModalListeners() {
            document.getElementById('close-calendar-btn').addEventListener('click', () => document.getElementById('calendar-modal').classList.remove('visible'));
            document.getElementById('prev-month-btn').addEventListener('click', () => {
                state.calendarState.month--;
                if (state.calendarState.month < 0) {
                    state.calendarState.month = 11;
                    state.calendarState.year--;
                }
                renderCalendar(state.calendarState.year, state.calendarState.month);
            });
            document.getElementById('next-month-btn').addEventListener('click', () => {
                state.calendarState.month++;
                if (state.calendarState.month > 11) {
                    state.calendarState.month = 0;
                    state.calendarState.year++;
                }
                renderCalendar(state.calendarState.year, state.calendarState.month);
            });
            document.getElementById('calendar-grid').addEventListener('click', (e) => {
                const dayEl = e.target.closest('.calendar-day');
                if (dayEl && !dayEl.classList.contains('other-month')) {
                    state.calendarState.selectedDate = new Date(state.calendarState.year, state.calendarState.month, parseInt(dayEl.textContent));
                    updateDeadlineDisplay();
                    document.getElementById('calendar-modal').classList.remove('visible');
                }
            });
            document.getElementById('clear-date-btn').addEventListener('click', () => {
                state.calendarState.selectedDate = null;
                updateDeadlineDisplay();
                document.getElementById('calendar-modal').classList.remove('visible');
            });
        }
        function showSchedulePanel(id = null) {
            const titleEl = document.getElementById('schedule-panel-title');
            if (id) {
                titleEl.textContent = 'ÁºñËæëÊó•Á®ã';
            } else {
                titleEl.textContent = 'Êñ∞Âª∫Êó•Á®ã';
            }
            resetScheduleState(id);
            ELS.schedulePanel.classList.add('visible');
            ELS.app.style.overflow = 'hidden';
        }
        function hideSchedulePanel() { ELS.schedulePanel.classList.remove('visible'); ELS.app.style.overflow = 'initial'; state.currentlyEditingScheduleId = null; }
        function setScheduleType(type) {
            document.getElementById('schedule-type-once').classList.toggle('active', type === 'once');
            document.getElementById('schedule-type-long').classList.toggle('active', type === 'long');
        }
        function setupImportanceStars() {
            document.getElementById('importance-stars').addEventListener('click', (e) => {
                const starEl = e.target.closest('.star');
                if (!starEl) return;
                const score = parseFloat(document.getElementById('importance-score').textContent);
                const starIndex = Array.from(starEl.parentElement.children).indexOf(starEl);
                const baseScore = starIndex * 2;
                if (score === baseScore + 2) {
                    updateStarsDisplay(baseScore + 1); // From full to half
                } else {
                    updateStarsDisplay(baseScore + 2); // From half or empty to full
                }
            });
        }
        function updateStarsDisplay(score) {
            document.getElementById('importance-score').textContent = score.toFixed(1);
            const stars = document.querySelectorAll('#importance-stars .star');
            const halfScore = score / 2;
            stars.forEach((star, index) => {
                star.classList.remove('filled', 'half');
                if (halfScore >= index + 1) {
                    star.classList.add('filled');
                } else if (halfScore > index) {
                    star.classList.add('half');
                }
            });
        }
        function resetScheduleState(id = null) {
            state.currentlyEditingScheduleId = id;
            let schedule = { eventType: 'once', title: '', description: '', importance: 0, deadline: null, completed: false };
            if (id) {
                const existing = state.schedules.find(s => s.id === id);
                if (existing) schedule = JSON.parse(JSON.stringify(existing)); // Deep copy
            }
            state.calendarState.selectedDate = schedule.deadline ? new Date(schedule.deadline.year, schedule.deadline.month-1, schedule.deadline.day) : null;
            
            setScheduleType(schedule.eventType);
            document.getElementById('schedule-title-input').value = schedule.title;
            updateStarsDisplay(schedule.importance);
            updateDeadlineDisplay();
            document.getElementById('deadline-hour-input').value = schedule.deadline?.hour ?? '';
            document.getElementById('deadline-minute-input').value = schedule.deadline?.minute ?? '';
            document.getElementById('schedule-description-input').value = schedule.description;
        }
        async function confirmSchedule() {
            const title = document.getElementById('schedule-title-input').value.trim();
            if (!title) { alert('ËØ∑ËæìÂÖ•Êó•Á®ãÊ†áÈ¢òÔºÅ'); return; }

            const hourVal = document.getElementById('deadline-hour-input').value;
            const minuteVal = document.getElementById('deadline-minute-input').value;
            const hour = (hourVal !== '' && !isNaN(parseInt(hourVal))) ? parseInt(hourVal) : null;
            const minute = (minuteVal !== '' && !isNaN(parseInt(minuteVal))) ? parseInt(minuteVal) : null;

            const deadline = state.calendarState.selectedDate ? {
                year: state.calendarState.selectedDate.getFullYear(),
                month: state.calendarState.selectedDate.getMonth() + 1,
                day: state.calendarState.selectedDate.getDate(),
                hour: (hour >= 0 && hour <= 23) ? hour : null,
                minute: (minute >= 0 && minute <= 59) ? minute : null,
            } : null;

            const scheduleData = {
                timestamp: Date.now(),
                eventType: document.getElementById('schedule-type-once').classList.contains('active') ? 'once' : 'long',
                title: title,
                importance: parseFloat(document.getElementById('importance-score').textContent),
                deadline: deadline,
                description: document.getElementById('schedule-description-input').value.trim(),
                completed: false
            };

            if (state.currentlyEditingScheduleId) {
                scheduleData.id = state.currentlyEditingScheduleId;
                const existing = state.schedules.find(s => s.id === scheduleData.id);
                scheduleData.completed = existing.completed;
                scheduleData.timestamp = existing.timestamp; // Preserve original creation time
                await db.schedules.put(scheduleData);
                const index = state.schedules.findIndex(s => s.id === scheduleData.id);
                state.schedules[index] = scheduleData;
                alert('Êó•Á®ãÂ∑≤Êõ¥Êñ∞ÔºÅ');
            } else {
                const id = await db.schedules.add(scheduleData);
                scheduleData.id = id;
                state.schedules.push(scheduleData);
                const msgId = await db.messages.add({ timestamp: scheduleData.timestamp, role: 'user', content: ``, type: 'schedule', relatedId: id });
                state.messages.push({ id: msgId, timestamp: scheduleData.timestamp, role: 'user', type: 'schedule', relatedId: id });
            }
            
            hideSchedulePanel();
            renderSchedules();
            renderChatMessages();
        }
        function classifySchedule(schedule) {
            const now = new Date();
            now.setHours(0,0,0,0);
            const threeDaysLater = new Date(now.getTime() + 3 * 24 * 60 * 60 * 1000);
            let isUrgent = false;

            if (schedule.eventType !== 'long' && schedule.deadline) {
                const deadlineDate = new Date(schedule.deadline.year, schedule.deadline.month - 1, schedule.deadline.day);
                if (deadlineDate <= threeDaysLater) isUrgent = true;
            }
            
            const isImportant = schedule.importance >= 6;
            if (isImportant && isUrgent) return 1;
            if (isImportant && !isUrgent) return 2;
            if (!isImportant && isUrgent) return 3;
            return 4;
        }
        function renderSchedules() {
            const quadrants = { 1: [], 2: [], 3: [], 4: [] };
            const completed = [];
            state.schedules.forEach(s => {
                if (s.completed) { completed.push(s); } else { quadrants[classifySchedule(s)].push(s); }
            });

            for (let i = 1; i <= 4; i++) {
                const container = document.getElementById(`quadrant-${i}-items`);
                container.innerHTML = '';
                if (quadrants[i].length > 0) {
                    quadrants[i].sort((a, b) => b.importance - a.importance).forEach(s => container.appendChild(createScheduleItemElement(s)));
                } else { container.innerHTML = `<div class="empty-state">Êó†</div>`; }
            }
            
            const completedContainer = document.getElementById('completed-items');
            completedContainer.innerHTML = '';
            if (completed.length > 0) {
                completed.sort((a, b) => b.timestamp - a.timestamp).forEach(s => completedContainer.appendChild(createScheduleItemElement(s)));
            } else { completedContainer.innerHTML = `<div class="empty-state">ËøòÊ≤°ÊúâÂ∑≤ÂÆåÊàêÁöÑÊó•Á®ã</div>`; }
        }
        function createScheduleItemElement(schedule) {
            const item = document.createElement('div');
            item.className = 'schedule-item';
            if (schedule.completed) item.classList.add('completed');
            item.dataset.id = schedule.id;
            item.innerHTML = `<div class="title">${schedule.title}</div><div class="checkbox"></div>`;
            item.querySelector('.checkbox').addEventListener('click', async (e) => {
                e.stopPropagation();
                schedule.completed = !schedule.completed;
                await db.schedules.update(schedule.id, { completed: schedule.completed });
                
                // Real-time update in chat
                const relatedMsg = state.messages.find(m => m.relatedId === schedule.id && m.type === 'schedule');
                if (relatedMsg) {
                    renderChatMessages(false);
                }
                
                renderSchedules();
            });
            item.addEventListener('click', () => showScheduleDetailModal(schedule.id));
            return item;
        }
        function showScheduleDetailModal(id) {
            const schedule = state.schedules.find(s => s.id === id);
            if (!schedule) return;
            state.currentlyEditingScheduleId = id;
            const modal = document.getElementById('schedule-detail-modal');
            document.getElementById('detail-title').textContent = schedule.title;
            document.getElementById('detail-description').textContent = schedule.description || 'Êó†';
            document.getElementById('detail-importance').textContent = `${schedule.importance.toFixed(1)} / 10.0`;
            document.getElementById('detail-deadline').textContent = schedule.deadline ? formatDeadline(schedule.deadline) : 'Êó†';
            document.getElementById('detail-type').textContent = schedule.eventType === 'long' ? 'ÈïøÊúü‰∫ã‰ª∂' : 'ÂçïÊ¨°‰∫ã‰ª∂';
            modal.classList.add('visible');
        }
        function handleEditScheduleFromModal() {
            document.getElementById('schedule-detail-modal').classList.remove('visible');
            showSchedulePanel(state.currentlyEditingScheduleId);
        }
        async function handleDeleteScheduleFromModal() {
            if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ê≠§Êó•Á®ãÂèäÂÖ∂ËÅäÂ§©ËÆ∞ÂΩïÂêóÔºü')) return;
            const id = state.currentlyEditingScheduleId;
            const msg = state.messages.find(m => m.relatedId === id && m.type === 'schedule');
            
            await db.schedules.delete(id);
            state.schedules = state.schedules.filter(s => s.id !== id);
            if (msg) {
                await db.messages.delete(msg.id);
                state.messages = state.messages.filter(m => m.id !== msg.id);
            }
            
            document.getElementById('schedule-detail-modal').classList.remove('visible');
            renderSchedules();
            renderChatMessages(false);
            state.currentlyEditingScheduleId = null;
        }
        function formatDeadline(deadlineObj) {
            if (!deadlineObj) return 'Êó†';
            const { year, month, day, hour, minute } = deadlineObj;
            let str = '';
            if (year && month && day) str += `${year}Âπ¥${month}Êúà${day}Êó•`;
            
            if (hour != null && minute != null) {
                if (str) str += ' ';
                str += `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
            }
            return str.trim() || 'Êó†';
        }
        function showCalendarModal() {
            const now = new Date();
            const initialDate = state.calendarState.selectedDate || now;
            state.calendarState.year = initialDate.getFullYear();
            state.calendarState.month = initialDate.getMonth();
            renderCalendar(state.calendarState.year, state.calendarState.month);
            document.getElementById('calendar-modal').classList.add('visible');
        }
        function renderCalendar(year, month) {
            const grid = document.getElementById('calendar-grid');
            document.getElementById('calendar-month-year').textContent = `${year}Âπ¥ ${month + 1}Êúà`;
            grid.innerHTML = '';
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = new Date();

            for (let i = 0; i < firstDay; i++) {
                grid.insertAdjacentHTML('beforeend', `<div></div>`);
            }
            for (let i = 1; i <= daysInMonth; i++) {
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day';
                dayEl.textContent = i;
                if (year === today.getFullYear() && month === today.getMonth() && i === today.getDate()) {
                    dayEl.classList.add('today');
                }
                if (state.calendarState.selectedDate && 
                    year === state.calendarState.selectedDate.getFullYear() && 
                    month === state.calendarState.selectedDate.getMonth() && 
                    i === state.calendarState.selectedDate.getDate()) {
                    dayEl.classList.add('selected');
                }
                grid.appendChild(dayEl);
            }
        }
        function updateDeadlineDisplay() {
            const textEl = document.getElementById('deadline-display-text');
            if (state.calendarState.selectedDate) {
                textEl.textContent = formatDeadline({
                    year: state.calendarState.selectedDate.getFullYear(),
                    month: state.calendarState.selectedDate.getMonth() + 1,
                    day: state.calendarState.selectedDate.getDate()
                });
                textEl.style.color = 'var(--text-primary)';
            } else {
                textEl.textContent = 'ÈÄâÊã©Êó•Êúü';
                textEl.style.color = 'var(--text-secondary)';
                document.getElementById('deadline-hour-input').value = '';
                document.getElementById('deadline-minute-input').value = '';
            }
        }

        // --- Forward to Chat ---
        async function forwardLedgerToChat() {
            const { filtered, displayCurrency } = getFilteredTransactions();
            const isChartView = document.getElementById('ledger-view-wrapper').style.transform === 'translateX(-100%)';

            if (isChartView) {
                // Sync pie chart data
                const expenseData = {};
                const incomeData = {};
                filtered.forEach(t => {
                    const data = t.type === 'expense' ? expenseData : incomeData;
                    if (!data[t.category]) data[t.category] = 0;
                    data[t.category] += t.displayAmount;
                });

                const totalExpense = Object.values(expenseData).reduce((s, a) => s + a, 0);
                const totalIncome = Object.values(incomeData).reduce((s, a) => s + a, 0);
                
                let summaryText = `${generatePieChartSubtitle()}ÁöÑË¥¶ÂçïÊÄªÁªìÔºö\n`;
                let hasData = false;
                if (totalExpense > 0) {
                    hasData = true;
                    summaryText += `ÊÄªÊîØÂá∫‰∏∫ ${totalExpense.toFixed(2)} ${displayCurrency}„ÄÇÂÖ∂‰∏≠Ôºö\n`;
                    summaryText += Object.entries(expenseData).map(([catId, amount]) => {
                        const cat = CATEGORIES.expense.find(c => c.id === catId);
                        const percentage = (amount / totalExpense * 100).toFixed(1);
                        return `- ${cat.name} ÊîØÂá∫ ${amount.toFixed(2)} ÂÖÉÔºåÂç†ÊØî ${percentage}%`;
                    }).join('\n');
                }
                if (totalIncome > 0) {
                    hasData = true;
                    if (totalExpense > 0) summaryText += '\n\n';
                    summaryText += `ÊÄªÊî∂ÂÖ•‰∏∫ ${totalIncome.toFixed(2)} ${displayCurrency}„ÄÇÂÖ∂‰∏≠Ôºö\n`;
                    summaryText += Object.entries(incomeData).map(([catId, amount]) => {
                        const cat = CATEGORIES.income.find(c => c.id === catId);
                        const percentage = (amount / totalIncome * 100).toFixed(1);
                        return `- ${cat.name} Êî∂ÂÖ• ${amount.toFixed(2)} ÂÖÉÔºåÂç†ÊØî ${percentage}%`;
                    }).join('\n');
                }

                if (!hasData) { alert('ÂΩìÂâçÁ≠õÈÄâÊù°‰ª∂‰∏ãÊ≤°ÊúâÊï∞ÊçÆÂèØÂêåÊ≠•'); return; }
                if (!confirm('Ë¶ÅÂ∞ÜÂΩìÂâçÂõæË°®ÂàÜÊûêÂêåÊ≠•Âà∞ËÅäÂ§©‰∏≠ÂêóÔºü')) return;
                
                const newMsg = { timestamp: Date.now(), role: 'user', content: summaryText, type: 'pie_chart_summary' };
                const id = await db.messages.add(newMsg);
                state.messages.push({ ...newMsg, id });
            } else {
                // Sync list data
                if (filtered.length === 0) { alert('ÂΩìÂâçÁ≠õÈÄâÊù°‰ª∂‰∏ãÊ≤°ÊúâÊï∞ÊçÆÂèØÂêåÊ≠•'); return; }
                if (!confirm('Ë¶ÅÂ∞ÜÂΩìÂâçÁ≠õÈÄâÁöÑË¥¶Êú¨ÂàóË°®ÂêåÊ≠•Âà∞ËÅäÂ§©‰∏≠ÂêóÔºü')) return;
                const newMsg = { timestamp: Date.now(), role: 'user', content: '', type: 'ledger_summary' };
                const id = await db.messages.add(newMsg);
                state.messages.push({ ...newMsg, id });
            }
            navigateTo('accounting-screen');
            renderChatMessages();
        }
        async function forwardScheduleToChat() {
            if (!confirm('Ë¶ÅÂ∞ÜÂÆåÊï¥ÁöÑÊó•Á®ã‰ø°ÊÅØÂêåÊ≠•Âà∞ËÅäÂ§©‰∏≠ÂêóÔºü')) return;
            const newMsg = { timestamp: Date.now(), role: 'user', content: '', type: 'schedule_summary' };
            const id = await db.messages.add(newMsg);
            state.messages.push({ ...newMsg, id });
            navigateTo('accounting-screen');
            renderChatMessages();
        }
        
        // --- Ledger Filter Modals ---
        function openMonthFilterModal() {
            const modal = document.getElementById('ledger-month-filter-modal');
            const list = document.getElementById('month-filter-list');
            list.innerHTML = '';
            
            const availableMonths = [...new Set(state.transactions.map(t => {
                const d = new Date(t.timestamp);
                return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
            }))].sort().reverse();
            
            availableMonths.forEach(monthStr => {
                const item = document.createElement('div');
                item.className = 'filter-item';
                const isChecked = state.ledgerFilters.months.includes(monthStr);
                item.innerHTML = `
                    <input type="checkbox" id="month-${monthStr}" value="${monthStr}" ${isChecked ? 'checked' : ''}>
                    <label for="month-${monthStr}">${monthStr.replace('-', 'Âπ¥')}Êúà</label>
                `;
                list.appendChild(item);
            });
            modal.classList.add('visible');
        }

        function openCategoryFilterModal() {
            const modal = document.getElementById('ledger-category-filter-modal');
            const renderList = (type) => {
                const list = document.getElementById('category-filter-list');
                list.innerHTML = '';
                CATEGORIES[type].forEach(cat => {
                    const item = document.createElement('div');
                    item.className = 'filter-item';
                    const isChecked = state.ledgerFilters.type === type && state.ledgerFilters.categories.includes(cat.id);
                    item.innerHTML = `
                        <input type="checkbox" id="cat-${cat.id}" value="${cat.id}" ${isChecked ? 'checked' : ''}>
                        <label for="cat-${cat.id}">${cat.name}</label>
                    `;
                    list.appendChild(item);
                });
            };

            const tabs = modal.querySelectorAll('.filter-tab');
            tabs.forEach(tab => {
                tab.classList.toggle('active', tab.dataset.type === state.ledgerFilters.type);
                tab.onclick = () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    renderList(tab.dataset.type);
                };
            });
            
            renderList(state.ledgerFilters.type);
            modal.classList.add('visible');
        }

        function applyLedgerFilters() {
            // Month filter
            const monthModal = document.getElementById('ledger-month-filter-modal');
            const selectedMonths = [];
            monthModal.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => {
                selectedMonths.push(cb.value);
            });
            state.ledgerFilters.months = selectedMonths;
            
            // Category filter
            const categoryModal = document.getElementById('ledger-category-filter-modal');
            const activeTab = categoryModal.querySelector('.filter-tab.active');
            if (activeTab) {
                state.ledgerFilters.type = activeTab.dataset.type;
                const selectedCategories = [];
                categoryModal.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => {
                    selectedCategories.push(cb.value);
                });
                state.ledgerFilters.categories = selectedCategories;
            }

            renderLedger();
        }

        // --- General & Utility Functions ---
        function fileToBase64(file) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = () => resolve(reader.result); reader.onerror = error => reject(error); }); }
        
        let cropper = null;
        function handleAvatarUpload(event, callback) {
            const file = event.target.files[0];
            if (!file) return;

            const modal = document.getElementById('cropper-modal');
            const image = document.getElementById('cropper-image');
            const saveBtn = modal.querySelector('.save-btn');
            
            const reader = new FileReader();
            reader.onload = (e) => {
                image.src = e.target.result;
                modal.classList.add('visible');
                
                if (cropper) cropper.destroy();
                cropper = new Cropper(image, {
                    aspectRatio: 1,
                    viewMode: 1,
                    background: false,
                    autoCropArea: 0.8,
                });
                
                saveBtn.onclick = () => {
                    const canvas = cropper.getCroppedCanvas({ width: 256, height: 256, });
                    const croppedBase64 = canvas.toDataURL('image/png');
                    callback(croppedBase64);
                    modal.classList.remove('visible');
                    cropper.destroy();
                    cropper = null;
                };
            };
            reader.readAsDataURL(file);
            event.target.value = ''; 
        }

        function download(filename, text, mimeType = 'text/plain') {
            const blob = new Blob(['\uFEFF' + text], { type: `${mimeType};charset=utf-8` });
            const element = document.createElement('a');
            element.href = URL.createObjectURL(blob);
            element.setAttribute('download', filename);
            element.style.display = 'none';
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
            URL.revokeObjectURL(element.href);
        }

        async function exportAsJSON() { const dataToExport = { appConfig: await db.appConfig.toArray(), transactions: await db.transactions.toArray(), messages: await db.messages.toArray(), apiProxies: await db.apiProxies.toArray(), aiCharacters: await db.aiCharacters.toArray(), currencies: await db.currencies.toArray(), schedules: await db.schedules.toArray() }; download('warm-bookkeeping-backup.json', JSON.stringify(dataToExport, null, 2), 'application/json'); }
        async function importFromJSON(event) { const file = event.target.files[0]; if (!file) return; if (!confirm('Ë≠¶ÂëäÔºöËøôÂ∞ÜË¶ÜÁõñÊâÄÊúâÁé∞ÊúâÊï∞ÊçÆÔºÅ‰Ω†Á°ÆÂÆöË¶ÅÁªßÁª≠ÂêóÔºü')) { event.target.value = ''; return; } const reader = new FileReader(); reader.onload = async (e) => { try { const data = JSON.parse(e.target.result); await db.transaction('rw', db.tables, async () => { for(const table of db.tables) { await table.clear(); } await Promise.all([ db.appConfig.bulkAdd(data.appConfig || []), db.transactions.bulkAdd(data.transactions || []), db.messages.bulkAdd(data.messages || []), db.apiProxies.bulkAdd(data.apiProxies || []), db.aiCharacters.bulkAdd(data.aiCharacters || []), db.currencies.bulkAdd(data.currencies || []), db.schedules.bulkAdd(data.schedules || []) ]); }); alert('ÂØºÂÖ•ÊàêÂäüÔºÅÂ∫îÁî®Â∞ÜÈáçÊñ∞Âä†ËΩΩ„ÄÇ'); location.reload(); } catch (err) { alert('ÂØºÂÖ•Â§±Ë¥•ÔºÅÊñá‰ª∂Ê†ºÂºèÈîôËØØÊàñÊï∞ÊçÆÊçüÂùè„ÄÇ'); console.error(err); } }; reader.readAsText(file, 'UTF-8'); event.target.value = ''; }
        function exportAsTXT() { let textContent = `ËÅäÂ§©ËÆ∞ÂΩïÂØºÂá∫ - ${new Date().toLocaleString()}\nÁæ§ËÅäÂêçÁß∞: ${state.config.chatName}\n=================================\n\n`; state.messages.forEach(msg => { const time = new Date(msg.timestamp).toLocaleString(); let sender = 'Êàë'; if (msg.role === 'assistant') { const char = state.characters.find(c => c.id === msg.senderId); sender = char ? char.name : 'AI'; } let content = ''; if (msg.type === 'text') { content = msg.content; } else if (msg.type === 'image') { content = '[ÂõæÁâá]'; } else if (msg.type === 'transaction') { const t = state.transactions.find(t => t.id === msg.relatedId); content = t ? `[ËÆ∞Ë¥¶] ${t.type==='expense'?'ÊîØÂá∫':'Êî∂ÂÖ•'} ${t.amount} ${t.currency} - ${CATEGORIES[t.type].find(c=>c.id===t.category)?.name}„ÄÇÂ§áÊ≥®Ôºö${t.remark}` : '[Â∑≤Âà†Èô§ÁöÑËÆ∞Ë¥¶]'; } else if (msg.type === 'schedule') { const s = state.schedules.find(s => s.id === msg.relatedId); content = s ? `[Êó•Á®ã] ${s.title}„ÄÇËØ¥ÊòéÔºö${s.description}` : '[Â∑≤Âà†Èô§ÁöÑÊó•Á®ã]'; } textContent += `${sender}  (${time})\n${content}\n\n`; }); download(`${state.config.chatName}-ËÅäÂ§©ËÆ∞ÂΩï.txt`, textContent); }
        function setupModal(triggerId, modalId, closeBtnId, onOpen) { const modal = document.getElementById(modalId); if (triggerId) { document.getElementById(triggerId).addEventListener('click', () => { if(onOpen) onOpen(); modal.classList.add('visible'); }); } if (closeBtnId) { document.getElementById(closeBtnId).addEventListener('click', () => modal.classList.remove('visible')); } modal.addEventListener('click', (e) => { if (e.target === modal) modal.classList.remove('visible'); }); }
        function setupEditorModal(modalId, onSave) { const modal = document.getElementById(modalId); const saveBtn = modal.querySelector('.save-btn'); const cancelBtns = modal.querySelectorAll('.cancel-btn'); if (saveBtn && onSave) saveBtn.addEventListener('click', onSave); cancelBtns.forEach(btn => btn.addEventListener('click', () => modal.classList.remove('visible'))); }
        function openProxyEditor(id = null) { const modal = document.getElementById('proxy-editor-modal'); const title = document.getElementById('proxy-editor-title'); const nameInput = document.getElementById('proxy-editor-name'); const urlInput = document.getElementById('proxy-editor-url'); const apikeyInput = document.getElementById('proxy-editor-apikey'); const modelsInput = document.getElementById('proxy-editor-models'); modal.dataset.id = id || ''; if (id) { const proxy = state.proxies.find(p => p.id === id); if (proxy) { title.textContent = 'ÁºñËæëÂèç‰ª£'; nameInput.value = proxy.name; urlInput.value = proxy.url; apikeyInput.value = proxy.apiKey; modelsInput.value = proxy.models.join('\n'); } } else { title.textContent = 'Ê∑ªÂä†Êñ∞Âèç‰ª£'; [nameInput, urlInput, apikeyInput, modelsInput].forEach(i => i.value = ''); } modal.classList.add('visible'); }
        async function saveProxy() { const modal = document.getElementById('proxy-editor-modal'); const id = parseInt(modal.dataset.id) || null; const name = document.getElementById('proxy-editor-name').value.trim(); const url = document.getElementById('proxy-editor-url').value.trim(); const apiKey = document.getElementById('proxy-editor-apikey').value.trim(); const models = document.getElementById('proxy-editor-models').value.split('\n').map(m => m.trim()).filter(Boolean); if (!name || !url || !apiKey || models.length === 0) { alert('ÊâÄÊúâÂ≠óÊÆµÂùá‰∏∫ÂøÖÂ°´È°π„ÄÇ'); return; } const proxyData = { name, url, apiKey, models }; if (id) { proxyData.id = id; await db.apiProxies.put(proxyData); const index = state.proxies.findIndex(p => p.id === id); if (index > -1) state.proxies[index] = proxyData; } else { const newId = await db.apiProxies.add(proxyData); state.proxies.push({ ...proxyData, id: newId }); } modal.classList.remove('visible'); renderProxyList(); }
        function renderProxyList() { const list = document.getElementById('proxy-list'); list.innerHTML = ''; state.proxies.forEach(p => { const item = document.createElement('div'); item.className = 'list-item-setting'; item.innerHTML = `<div class="name">${p.name}</div><div class="details">${p.url}</div><div class="list-item-actions"><button data-id="${p.id}" class="edit-btn">‚úèÔ∏è</button><button data-id="${p.id}" class="delete-btn">üóëÔ∏è</button></div>`; list.appendChild(item); }); list.querySelectorAll('.edit-btn').forEach(b => b.addEventListener('click', (e) => openProxyEditor(parseInt(e.currentTarget.dataset.id)))); list.querySelectorAll('.delete-btn').forEach(b => b.addEventListener('click', async (e) => { const id = parseInt(e.currentTarget.dataset.id); if (confirm('Á°ÆÂÆöÂà†Èô§ÂêóÔºü')) { await db.apiProxies.delete(id); state.proxies = state.proxies.filter(p => p.id !== id); renderProxyList(); } })); }
        function openCharacterEditor(id = null) { const modal = document.getElementById('character-editor-modal'); const title = document.getElementById('character-editor-title'); const nameInput = document.getElementById('character-editor-name'); const avatarPreview = document.getElementById('character-editor-avatar-preview'); const promptInput = document.getElementById('character-editor-prompt'); const proxySelect = document.getElementById('character-editor-proxy'); const modelSelect = document.getElementById('character-editor-model'); const backupProxySelect = document.getElementById('character-editor-backup-proxy'); const backupModelSelect = document.getElementById('character-editor-backup-model'); const populateSelect = (select, data, selectedId) => { select.innerHTML = '<option value="">-- Êó† --</option>'; data.forEach(item => { const option = document.createElement('option'); option.value = item.id; option.textContent = item.name; select.appendChild(option); }); if (selectedId) select.value = selectedId; }; populateSelect(proxySelect, state.proxies); populateSelect(backupProxySelect, state.proxies); const updateModels = (proxySelect, modelSelectToUpdate, selectedModel) => { const proxyId = parseInt(proxySelect.value); modelSelectToUpdate.innerHTML = ''; if (proxyId) { const proxy = state.proxies.find(p => p.id === proxyId); if (proxy) { proxy.models.forEach(m => { const option = document.createElement('option'); option.value = m; option.textContent = m; modelSelectToUpdate.appendChild(option); }); if (selectedModel) modelSelectToUpdate.value = selectedModel; } } }; proxySelect.onchange = () => updateModels(proxySelect, modelSelect); backupProxySelect.onchange = () => updateModels(backupProxySelect, backupModelSelect); document.getElementById('upload-char-avatar-btn').onclick = () => document.getElementById('character-editor-avatar-input').click(); document.getElementById('character-editor-avatar-input').onchange = (e) => { handleAvatarUpload(e, (base64) => { avatarPreview.src = base64; modal.dataset.avatar = base64; }); }; modal.dataset.id = id || ''; modal.dataset.avatar = ''; if (id) { const char = state.characters.find(c => c.id === id); if (char) { title.textContent = 'ÁºñËæëËßíËâ≤'; nameInput.value = char.name; avatarPreview.src = char.avatar || DEFAULT_AVATAR; modal.dataset.avatar = char.avatar; promptInput.value = char.prompt; populateSelect(proxySelect, state.proxies, char.proxyId); updateModels(proxySelect, modelSelect, char.model); populateSelect(backupProxySelect, state.proxies, char.backupProxyId); updateModels(backupProxySelect, backupModelSelect, char.backupModel); } } else { title.textContent = 'Ê∑ªÂä†Êñ∞ËßíËâ≤'; [nameInput, promptInput].forEach(i => i.value = ''); avatarPreview.src = DEFAULT_AVATAR; populateSelect(proxySelect, state.proxies); modelSelect.innerHTML = ''; populateSelect(backupProxySelect, state.proxies); backupModelSelect.innerHTML = ''; } modal.classList.add('visible'); }
        async function saveCharacter() { const modal = document.getElementById('character-editor-modal'); const id = parseInt(modal.dataset.id) || null; const name = document.getElementById('character-editor-name').value.trim(); const avatar = modal.dataset.avatar || DEFAULT_AVATAR; const prompt = document.getElementById('character-editor-prompt').value.trim(); const proxyId = parseInt(document.getElementById('character-editor-proxy').value) || null; const model = document.getElementById('character-editor-model').value || null; const backupProxyId = parseInt(document.getElementById('character-editor-backup-proxy').value) || null; const backupModel = document.getElementById('character-editor-backup-model').value || null; if (!name || !prompt || !proxyId || !model) { alert('ËßíËâ≤ÂêçÁß∞„ÄÅPrompt„ÄÅ‰∏ªÁî®APIÂíå‰∏ªÁî®Ê®°Âûã‰∏∫ÂøÖÂ°´È°π„ÄÇ'); return; } const charData = { name, avatar, prompt, proxyId, model, backupProxyId, backupModel }; if (id) { charData.id = id; await db.aiCharacters.put(charData); const index = state.characters.findIndex(c => c.id === id); if (index > -1) state.characters[index] = charData; } else { const newId = await db.aiCharacters.add(charData); state.characters.push({ ...charData, id: newId }); } modal.classList.remove('visible'); renderCharacterList(); }
        function renderCharacterList() { const list = document.getElementById('character-list'); list.innerHTML = ''; state.characters.forEach(c => { const item = document.createElement('div'); item.className = 'list-item-setting'; item.innerHTML = `<div class="name">${c.name}</div><div class="list-item-actions"><button data-id="${c.id}" class="edit-btn">‚úèÔ∏è</button><button data-id="${c.id}" class="delete-btn">üóëÔ∏è</button></div>`; list.appendChild(item); }); list.querySelectorAll('.edit-btn').forEach(b => b.addEventListener('click', (e) => openCharacterEditor(parseInt(e.currentTarget.dataset.id)))); list.querySelectorAll('.delete-btn').forEach(b => b.addEventListener('click', async (e) => { const id = parseInt(e.currentTarget.dataset.id); if (confirm('Á°ÆÂÆöÂà†Èô§ÂêóÔºü')) { await db.aiCharacters.delete(id); state.characters = state.characters.filter(c => c.id !== id); renderCharacterList(); } })); }
        function showAICharacterSelector() { const modal = document.getElementById('ai-character-selector-modal'); const selector = document.getElementById('ai-character-selector'); selector.innerHTML = ''; if (state.characters.length === 0) { selector.innerHTML = '<p style="text-align:center; color: var(--text-secondary);">ËØ∑ÂÖàÂú®ËÆæÁΩÆ‰∏≠Ê∑ªÂä†AIËßíËâ≤„ÄÇ</p>'; } else { state.characters.forEach(char => { const item = document.createElement('div'); item.className = 'character-item'; item.innerHTML = `<img src="${char.avatar}" alt="${char.name}"><div class="name">${char.name}</div>`; item.onclick = () => { modal.classList.remove('visible'); triggerAIResponse(char); }; selector.appendChild(item); }); } modal.classList.add('visible'); }
        function openCurrencyEditor(code = null) { const modal = document.getElementById('currency-editor-modal'); const title = document.getElementById('currency-editor-title'); const codeInput = document.getElementById('currency-editor-code'); const nameInput = document.getElementById('currency-editor-name'); const rateInput = document.getElementById('currency-editor-rate'); modal.dataset.code = code || ''; if (code) { const currency = state.currencies.find(c => c.code === code); if (currency) { title.textContent = 'ÁºñËæëÂ∏ÅÁßç'; codeInput.value = currency.code; codeInput.disabled = true; nameInput.value = currency.name; rateInput.value = currency.rate; } } else { title.textContent = 'Ê∑ªÂä†Êñ∞Â∏ÅÁßç'; [codeInput, nameInput, rateInput].forEach(i => i.value = ''); codeInput.disabled = false; } modal.classList.add('visible'); }
        async function saveCurrency() { const modal = document.getElementById('currency-editor-modal'); const originalCode = modal.dataset.code; const code = document.getElementById('currency-editor-code').value.trim().toUpperCase(); const name = document.getElementById('currency-editor-name').value.trim(); const rate = parseFloat(document.getElementById('currency-editor-rate').value); if (!/^[A-Z]{3}$/.test(code)) { alert('Â∏ÅÁßç‰ª£Á†ÅÂøÖÈ°ªÊòØ3‰ΩçÂ§ßÂÜôÂ≠óÊØç„ÄÇ'); return; } if (!name || isNaN(rate) || rate <= 0) { alert('ËØ∑Â°´ÂÜôÊúâÊïàÁöÑÂ∏ÅÁßçÂêçÁß∞ÂíåÊ±áÁéá„ÄÇ'); return; } if (!originalCode && state.currencies.some(c => c.code === code)) { alert('ËØ•Â∏ÅÁßç‰ª£Á†ÅÂ∑≤Â≠òÂú®„ÄÇ'); return; } const currencyData = { code, name, rate }; await db.currencies.put(currencyData); if (originalCode) { const index = state.currencies.findIndex(c => c.code === originalCode); if (index > -1) state.currencies[index] = currencyData; } else { state.currencies.push(currencyData); } modal.classList.remove('visible'); renderCurrencyList(); populateLedgerCurrencyFilter(); }
        function renderCurrencyList() { const list = document.getElementById('currency-list'); list.innerHTML = ''; state.currencies.forEach(c => { const item = document.createElement('div'); item.className = 'list-item-setting'; item.innerHTML = `<div class="name">${c.name} (${c.code})</div><div class="details">1 ${c.code} ‚âà ${c.rate} RMB</div><div class="list-item-actions"><button data-code="${c.code}" class="edit-btn">‚úèÔ∏è</button><button data-code="${c.code}" class="delete-btn">üóëÔ∏è</button></div>`; list.appendChild(item); }); list.querySelectorAll('.edit-btn').forEach(b => b.addEventListener('click', (e) => openCurrencyEditor(e.currentTarget.dataset.code))); list.querySelectorAll('.delete-btn').forEach(b => b.addEventListener('click', async (e) => { const code = e.currentTarget.dataset.code; if (confirm('Á°ÆÂÆöÂà†Èô§ÂêóÔºü')) { await db.currencies.delete(code); state.currencies = state.currencies.filter(c => c.code !== code); renderCurrencyList(); populateLedgerCurrencyFilter(); } })); }
        function toggleSidebar() { ELS.sidebar.classList.toggle('visible'); ELS.sidebarOverlay.classList.toggle('visible'); if (ELS.sidebar.classList.contains('visible')) { const { tokens } = buildContext(state.config.maxTokens); ELS.sidebarTokenCount.textContent = tokens; } }
        function toggleContextPreview() { const content = ELS.sidebarPreviewContent; if (content.style.display === 'block') { content.style.display = 'none'; } else { const { context } = buildContext(state.config.maxTokens); content.textContent = JSON.stringify(context, null, 2); content.style.display = 'block'; } }
        function openSystemPromptsEditor() {
            const { sendTime, sendModel, sendRole, ledger, schedule, pie } = state.config.systemPromptSettings;
            document.getElementById('system-prompt-send-time').checked = sendTime;
            document.getElementById('system-prompt-send-model').checked = sendModel;
            document.getElementById('system-prompt-send-role').checked = sendRole;
            document.getElementById('system-prompt-ledger').value = ledger;
            document.getElementById('system-prompt-schedule').value = schedule;
            document.getElementById('system-prompt-pie').value = pie;
        }
        async function saveSystemPrompts() {
            const newSettings = {
                sendTime: document.getElementById('system-prompt-send-time').checked,
                sendModel: document.getElementById('system-prompt-send-model').checked,
                sendRole: document.getElementById('system-prompt-send-role').checked,
                ledger: document.getElementById('system-prompt-ledger').value.trim(),
                schedule: document.getElementById('system-prompt-schedule').value.trim(),
                pie: document.getElementById('system-prompt-pie').value.trim()
            };
            await updateConfig('systemPromptSettings', newSettings);
            document.getElementById('system-prompts-modal').classList.remove('visible');
            alert('Á≥ªÁªüÊèêÁ§∫ËØçÂ∑≤‰øùÂ≠òÔºÅ');
        }

        init();
    });
    </script>
</body>
</html>
